<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student QR Grading System</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Scanner Library: html5-qrcode -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <!-- QR Code Generator Library: qrcode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
        }
        /* Style for the QR scanner viewfinder */
        #reader, #report-reader {
            border: 2px solid #4a5568;
            border-radius: 0.75rem; /* 12px */
            overflow: hidden;
        }
        #reader video, #report-reader video {
            width: 100% !important;
            height: auto !important;
        }
        /* Hides library's native UI elements for a cleaner look */
        #reader__dashboard_section_csr, #reader__dashboard_section_fsr,
        #report-reader__dashboard_section_csr, #report-reader__dashboard_section_fsr {
            display: none !important;
        }
        /* Ensure generated QR code is centered and clear */
        #qrcode-display canvas, #detail-qrcode canvas {
            margin: 0 auto;
            border: 5px solid white;
            border-radius: 10px;
        }
        /* Custom scrollbar for lists */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        /* Active tab style */
        .tab-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        /* Grades table styling */
        .grades-table th, .grades-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #4a5568;
        }
        .grades-table th {
            background-color: #2d3748;
        }
        .grades-table .missing-grade {
            color: #f87171; /* red-400 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto">
        <!-- Main Application Sections -->

        <!-- Section 1: Management Dashboard -->
        <div id="management-dashboard-section" class="hidden bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-2xl font-bold text-white">Management Dashboard</h1>
                 <div class="flex items-center gap-2">
                    <button id="import-data-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-3 rounded-lg text-sm">Import</button>
                    <button id="export-data-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-lg text-sm">Export</button>
                    <button id="clear-data-btn" class="bg-red-700 hover:bg-red-800 text-white font-semibold py-2 px-3 rounded-lg text-sm">Clear Data</button>
                    <button class="back-btn text-gray-400 hover:text-white">&larr; Back</button>
                </div>
            </div>
            <input type="file" id="import-file-input" class="hidden" accept="application/json">
            
            <!-- Tab Navigation -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 bg-gray-900 p-1 rounded-lg">
                <button class="tab-btn p-2 rounded-md text-sm md:text-base font-semibold" data-tab="schools">Schools</button>
                <button class="tab-btn p-2 rounded-md text-sm md:text-base font-semibold" data-tab="courses">Courses</button>
                <button class="tab-btn p-2 rounded-md text-sm md:text-base font-semibold" data-tab="tasks">Tasks</button>
                <button class="tab-btn p-2 rounded-md text-sm md:text-base font-semibold" data-tab="students">Students</button>
            </div>

            <!-- Tab Content -->
            <div id="tab-content" class="min-h-[400px]">
                <!-- Schools View -->
                <div id="schools-view" class="tab-pane hidden space-y-4">
                    <h2 class="text-xl font-semibold text-white">Manage Schools</h2>
                    <div class="flex gap-2">
                        <input type="text" id="new-school-name" placeholder="New School Name" class="flex-grow bg-gray-700 border border-gray-600 rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500">
                        <button id="add-school-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Add</button>
                    </div>
                    <div id="schools-list" class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar pr-2"></div>
                </div>

                <!-- Courses View -->
                <div id="courses-view" class="tab-pane hidden space-y-4">
                    <h2 class="text-xl font-semibold text-white">Manage Courses</h2>
                    <div>
                        <label for="course-school-select" class="block text-sm font-medium text-gray-300 mb-2">Select School</label>
                        <select id="course-school-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3"></select>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="new-course-name" placeholder="New Course Name" class="flex-grow bg-gray-700 border border-gray-600 rounded-lg p-3">
                        <button id="add-course-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Add</button>
                    </div>
                    <div id="courses-list" class="space-y-2 max-h-72 overflow-y-auto custom-scrollbar pr-2"></div>
                </div>

                <!-- Tasks View -->
                <div id="tasks-view" class="tab-pane hidden space-y-4">
                     <h2 class="text-xl font-semibold text-white">Manage Tasks</h2>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                           <label for="task-school-select" class="block text-sm font-medium text-gray-300 mb-2">School</label>
                           <select id="task-school-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3"></select>
                        </div>
                        <div>
                           <label for="task-course-select" class="block text-sm font-medium text-gray-300 mb-2">Course</label>
                           <select id="task-course-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3"></select>
                        </div>
                     </div>
                     <div class="bg-gray-900 p-3 rounded-lg text-center mt-4">
                        <p class="text-sm text-gray-400">Points Remaining to Allocate</p>
                        <p id="course-remaining-points-display" class="text-2xl font-bold text-white">--</p>
                    </div>
                     <div class="flex gap-2 mt-4">
                        <input type="text" id="new-task-name" placeholder="Task Name (e.g., Midterm Exam)" class="flex-grow bg-gray-700 border border-gray-600 rounded-lg p-3">
                        <input type="number" id="new-task-value" placeholder="Value" min="1" max="100" class="w-24 bg-gray-700 border border-gray-600 rounded-lg p-3">
                        <button id="add-task-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Add</button>
                    </div>
                    <div id="tasks-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2 mt-4"></div>
                </div>

                <!-- Students View -->
                <div id="students-view" class="tab-pane hidden space-y-4">
                    <h2 class="text-xl font-semibold text-white">Manage Students</h2>
                    <button id="show-add-student-modal-btn" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-4 rounded-lg">Add New Student</button>
                    <div id="students-list" class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar pr-2"></div>
                </div>
            </div>
        </div>
        
        <!-- Section 2: QR Reader to Set Grade -->
        <div id="qr-reader-section" class="hidden bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
             <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-white">Scan Student QR</h1>
                <button class="back-btn text-gray-400 hover:text-white">&larr; Back</button>
            </div>
            <div class="bg-gray-900 rounded-xl aspect-square w-full">
                <div id="reader" class="w-full"></div>
            </div>
            <div id="scan-status" class="text-center text-gray-400 h-6"></div>
            <button id="start-scan-btn" class="w-full bg-emerald-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-emerald-600">Start Scan</button>
            <button id="manual-select-btn" class="w-full text-center text-emerald-400 hover:text-emerald-300 mt-2 text-sm">Can't scan? Select student manually</button>
        </div>
        
        <!-- Section 3: Grades Dashboard -->
        <div id="grades-dashboard-section" class="hidden bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-white">Grades Dashboard</h1>
                <button class="back-btn text-gray-400 hover:text-white">&larr; Back</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                <div>
                   <label for="grades-school-select" class="block text-sm font-medium text-gray-300 mb-2">School</label>
                   <select id="grades-school-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3"></select>
                </div>
                <div class="flex gap-2">
                   <div class="flex-grow">
                       <label for="grades-course-select" class="block text-sm font-medium text-gray-300 mb-2">Course</label>
                       <select id="grades-course-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3"></select>
                   </div>
                   <button id="export-csv-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold p-3 rounded-lg self-end">Export CSV</button>
                </div>
            </div>
            <div class="overflow-x-auto custom-scrollbar">
                <table id="grades-table" class="w-full text-sm text-left text-gray-300 grades-table">
                    <thead id="grades-table-head"></thead>
                    <tbody id="grades-table-body"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Section 4: Student Report Section -->
        <div id="student-report-section" class="hidden bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-white">View Student Report</h1>
                <button class="back-btn text-gray-400 hover:text-white">&larr; Back</button>
            </div>
            <div id="report-scanner-view">
                <div class="bg-gray-900 rounded-xl aspect-square w-full">
                    <div id="report-reader" class="w-full"></div>
                </div>
                <div id="report-scan-status" class="text-center text-gray-400 h-6"></div>
                <button id="start-report-scan-btn" class="w-full bg-teal-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-teal-600">Scan Student QR for Report</button>
                <button id="manual-select-report-btn" class="w-full text-center text-teal-400 hover:text-teal-300 mt-2 text-sm">Can't scan? Select student manually</button>
            </div>
            <div id="report-card-view" class="hidden"></div>
        </div>

    </div>


    <!-- Modals -->

    <!-- Initial Selection Modal -->
    <div id="selection-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4">
        <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-8 space-y-6">
            <h1 class="text-2xl md:text-3xl font-bold text-white text-center">Grading System Menu</h1>
            <p class="text-center text-gray-400">What would you like to do?</p>
            <div class="flex flex-col space-y-4">
                <button data-action="dashboard" class="action-btn bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg">Management Dashboard</button>
                <button data-action="grades-dashboard" class="action-btn bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg">Grades Dashboard</button>
                <button data-action="student-report" class="action-btn bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 rounded-lg">View Student Report</button>
                <button data-action="scan" class="action-btn bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 rounded-lg">Scan QR to Set Grade</button>
            </div>
        </div>
    </div>

    <!-- Set Grade Modal -->
    <div id="set-grade-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4">
         <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-8 space-y-4">
            <h2 class="text-2xl font-bold text-white">Set Grade for <span id="grade-student-name" class="text-emerald-400"></span></h2>
            <input type="hidden" id="grade-student-id">
            <div>
                <label for="task-select" class="block text-sm font-medium text-gray-300 mb-2">Select Task</label>
                <select id="task-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3"></select>
            </div>
             <div>
                <label for="grade-value" class="block text-sm font-medium text-gray-300 mb-2">
                    Grade <span id="grade-max-value" class="text-gray-400 font-normal"></span>
                </label>
                <input type="number" id="grade-value" placeholder="Enter grade" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3">
            </div>
            <div class="flex gap-4 pt-4">
                <button id="cancel-grade-btn" class="w-full bg-gray-600 hover:bg-gray-700 font-semibold py-3 rounded-lg">Cancel</button>
                <button id="save-grade-btn" class="w-full bg-emerald-500 hover:bg-emerald-600 font-semibold py-3 rounded-lg">Save Grade</button>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Student Modal -->
    <div id="student-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4">
        <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-8 space-y-4">
            <h2 id="student-modal-title" class="text-2xl font-bold text-white">Add New Student</h2>
            <input type="hidden" id="student-id-input">
            <div>
                <label for="student-name-input" class="block text-sm font-medium text-gray-300 mb-2">Student Full Name</label>
                <input type="text" id="student-name-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3">
            </div>
            <div>
                <label for="student-school-select" class="block text-sm font-medium text-gray-300 mb-2">School</label>
                <select id="student-school-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3"></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Enroll in Courses</label>
                <div id="student-courses-checklist" class="space-y-2 max-h-40 overflow-y-auto bg-gray-900 p-3 rounded-lg"></div>
            </div>
             <div id="student-qrcode-container" class="hidden text-center space-y-2">
                 <p class="text-gray-300 text-sm">Student QR Code</p>
                 <div id="student-qrcode-display" class="bg-gray-700 p-2 inline-block rounded-xl cursor-pointer"></div>
                 <p class="text-xs text-gray-500 mt-2">Click QR code to enlarge. Then, take a screenshot to share.</p>
                 <button id="share-qr-whatsapp-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg mt-2 text-sm">Share Instructions via WhatsApp</button>
             </div>
            <div class="flex gap-4 pt-4">
                <button id="cancel-student-btn" class="w-full bg-gray-600 hover:bg-gray-700 font-semibold py-3 rounded-lg">Cancel</button>
                <button id="save-student-btn" class="w-full bg-emerald-500 hover:bg-emerald-600 font-semibold py-3 rounded-lg">Save Student</button>
            </div>
             <button id="delete-student-btn" class="hidden w-full bg-red-600 hover:bg-red-700 font-semibold py-3 rounded-lg mt-4">Delete Student</button>
        </div>
    </div>

    <!-- Manual Student Selection Modal -->
    <div id="manual-select-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4">
         <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-8 space-y-4 flex flex-col">
            <div class="flex-shrink-0">
                <div class="flex justify-between items-start">
                    <h2 class="text-2xl font-bold text-white">Select Student</h2>
                    <button id="close-manual-select-modal" class="text-3xl leading-none text-gray-400 hover:text-white">&times;</button>
                </div>
                <div class="mt-4">
                    <input type="search" id="student-search-input" placeholder="Search by name..." class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3">
                </div>
            </div>
            <div id="manual-student-list" class="flex-grow overflow-y-auto space-y-2 pr-2 mt-4 max-h-80 custom-scrollbar"></div>
        </div>
    </div>
    
    <!-- Generic Message Box -->
    <div id="message-box" class="hidden fixed top-5 left-1/2 -translate-x-1/2 z-[100] p-4 rounded-md text-white font-semibold shadow-lg">
        <p id="message-text"></p>
    </div>

    <!-- Generic Edit Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4">
        <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-8 space-y-4">
            <h2 id="edit-modal-title" class="text-2xl font-bold text-white">Edit Item</h2>
            <input type="hidden" id="edit-item-id">
            <input type="hidden" id="edit-item-type">
            <div>
                <label for="edit-item-name" class="block text-sm font-medium text-gray-300 mb-2">Name</label>
                <input type="text" id="edit-item-name" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3">
            </div>
            <div id="edit-task-value-container" class="hidden">
                <label for="edit-item-value" class="block text-sm font-medium text-gray-300 mb-2">Value (1-100)</label>
                <input type="number" id="edit-item-value" min="1" max="100" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3">
            </div>
            <div class="flex gap-4 pt-4">
                <button id="cancel-edit-btn" class="w-full bg-gray-600 hover:bg-gray-700 font-semibold py-3 rounded-lg">Cancel</button>
                <button id="save-edit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 font-semibold py-3 rounded-lg">Save Changes</button>
            </div>
        </div>
    </div>
    
    <!-- Confirm Grade Update Modal -->
    <div id="confirm-grade-update-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4">
        <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-8 space-y-4">
            <h2 class="text-2xl font-bold text-white">Confirm Grade Update</h2>
            <p class="text-gray-400">This task has already been graded. Do you want to overwrite the existing grade?</p>
            <div class="bg-gray-900 p-4 rounded-lg space-y-3 text-center">
                <div>
                    <p class="text-sm font-medium text-gray-500">Current Grade</p>
                    <p class="text-xl font-bold text-red-400" id="old-grade-value"></p>
                    <p class="text-xs text-gray-500" id="old-grade-date"></p>
                </div>
                <div class="text-2xl font-light text-gray-400">&darr;</div>
                <div>
                    <p class="text-sm font-medium text-gray-500">New Grade</p>
                    <p class="text-xl font-bold text-emerald-400" id="new-grade-value"></p>
                </div>
            </div>
            <div class="flex gap-4 pt-4">
                <button id="cancel-update-btn" class="w-full bg-gray-600 hover:bg-gray-700 font-semibold py-3 rounded-lg">Cancel</button>
                <button id="confirm-update-btn" class="w-full bg-emerald-500 hover:bg-emerald-600 font-semibold py-3 rounded-lg">Confirm Update</button>
            </div>
        </div>
    </div>

    <!-- Fullscreen QR Code Modal -->
    <div id="fullscreen-qr-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center modal-backdrop p-4">
        <img id="fullscreen-qr-image" class="max-w-full max-h-full p-8 bg-white rounded-lg" src="">
        <button id="close-fullscreen-qr-btn" class="absolute top-4 right-4 text-white text-5xl font-bold">&times;</button>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center modal-backdrop p-4">
        <div class="w-full max-w-sm bg-gray-800 rounded-2xl shadow-2xl p-8 space-y-4">
            <h1 class="text-2xl font-bold text-white text-center">Enter Access Code</h1>
            <input type="password" id="password-input" placeholder="Password" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-3 text-center tracking-widest">
            <button id="password-submit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-lg">Enter</button>
            <p id="password-error" class="text-red-400 text-center text-sm h-4"></p>
        </div>
    </div>


    <script type="module">
        // --- CONSTANTS & DOM Elements ---
        const DB_KEY = 'grading_system_db_v4';
        const PASSWORD = '318dac5';
        const SESSION_DURATION_MS = 3 * 60 * 60 * 1000; // 3 hours

        const sections = {
            dashboard: document.getElementById('management-dashboard-section'),
            scan: document.getElementById('qr-reader-section'),
            "grades-dashboard": document.getElementById('grades-dashboard-section'),
            "student-report": document.getElementById('student-report-section'),
        };
        const modals = {
            selection: document.getElementById('selection-modal'),
            setGrade: document.getElementById('set-grade-modal'),
            student: document.getElementById('student-modal'),
            manualSelect: document.getElementById('manual-select-modal'),
            edit: document.getElementById('edit-modal'),
            confirmGradeUpdate: document.getElementById('confirm-grade-update-modal'),
            fullscreenQr: document.getElementById('fullscreen-qr-modal'),
            password: document.getElementById('password-modal')
        };

        // --- Database Logic ---
        const DB = {
            getData: () => {
                const data = JSON.parse(localStorage.getItem(DB_KEY));
                return data || { schools: {}, courses: {}, tasks: {}, students: {} };
            },
            saveData: (data) => {
                localStorage.setItem(DB_KEY, JSON.stringify(data));
            },
            clearData: () => {
                localStorage.removeItem(DB_KEY);
            }
        };

        // --- Utility Functions ---
        let messageTimeout;
        function showMessage(text, isError = false, duration = 3000) {
            const box = document.getElementById('message-box');
            document.getElementById('message-text').textContent = text;
            box.className = `fixed top-5 left-1/2 -translate-x-1/2 z-[100] p-4 rounded-md text-white font-semibold shadow-lg ${isError ? 'bg-red-600' : 'bg-emerald-600'}`;
            clearTimeout(messageTimeout);
            box.classList.remove('hidden');
            if (duration) {
                messageTimeout = setTimeout(() => box.classList.add('hidden'), duration);
            }
        }
        
        function showSection(sectionKey) {
            modals.selection.classList.add('hidden');
            Object.values(sections).forEach(s => s.classList.add('hidden'));
            if (sections[sectionKey]) {
                sections[sectionKey].classList.remove('hidden');
            }
        }

        function showMainMenu() {
            Object.values(sections).forEach(s => s.classList.add('hidden'));
            modals.selection.classList.remove('hidden');
            stopScan();
            stopReportScan();
        }
        
        // --- Authentication Logic ---
        function checkAuth() {
            const loginTimestamp = localStorage.getItem('login_timestamp');
            if (loginTimestamp) {
                const now = new Date().getTime();
                if (now - parseInt(loginTimestamp) < SESSION_DURATION_MS) {
                    modals.password.classList.add('hidden');
                    showMainMenu();
                    return;
                }
            }
            modals.password.classList.remove('hidden');
            modals.selection.classList.add('hidden');
            Object.values(sections).forEach(s => s.classList.add('hidden'));
        }

        document.getElementById('password-submit-btn').addEventListener('click', () => {
            const input = document.getElementById('password-input');
            const errorP = document.getElementById('password-error');
            if (input.value === PASSWORD) {
                localStorage.setItem('login_timestamp', new Date().getTime().toString());
                modals.password.classList.add('hidden');
                showMainMenu();
                errorP.textContent = '';
                input.value = '';
            } else {
                errorP.textContent = 'Incorrect password.';
                input.value = '';
            }
        });
         document.getElementById('password-input').addEventListener('keypress', (e) => {
             if (e.key === 'Enter') {
                 document.getElementById('password-submit-btn').click();
             }
        });

        // --- Management Dashboard Logic ---
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabPanes = document.querySelectorAll('.tab-pane');

        function switchTab(tabKey) {
            tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabKey));
            tabPanes.forEach(pane => pane.classList.toggle('hidden', pane.id !== `${tabKey}-view`));
            switch (tabKey) {
                case 'schools': renderSchools(); break;
                case 'courses': populateSchoolSelect('course-school-select', renderCourses); break;
                case 'tasks': populateSchoolSelect('task-school-select', () => populateCourseSelect('task-course-select', 'task-school-select', renderTasks)); break;
                case 'students': renderStudents(); break;
            }
        }
        
        tabButtons.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
        
        // --- Generic CRUD Rendering ---
        function renderItem(item, type, onEdit, onDelete) {
            const div = document.createElement('div');
            div.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center';
            
            let displayName = `<p class="text-white">${item.name}</p>`;
            if (type === 'tasks' && item.value) {
                displayName = `<p class="text-white">${item.name} <span class="text-sm text-gray-400">(${item.value} pts)</span></p>`;
            }
            div.innerHTML = displayName;

            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'flex gap-2';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'edit-btn bg-gray-600 hover:bg-gray-500 text-xs font-bold py-1 px-2 rounded';
            editBtn.textContent = 'Edit';
            editBtn.onclick = () => onEdit(item, type);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn bg-red-700 hover:bg-red-600 text-xs font-bold py-1 px-2 rounded';
            deleteBtn.textContent = 'Delete';
            deleteBtn.onclick = () => onDelete(item.id, item.name, type);
            
            buttonsDiv.appendChild(editBtn);
            buttonsDiv.appendChild(deleteBtn);
            div.appendChild(buttonsDiv);
            return div;
        }

        function genericDelete(id, name, type) {
            if (!confirm(`Are you sure you want to delete "${name}"? This might affect related items (courses, students, etc.) and cannot be undone.`)) return;
            let data = DB.getData();
            delete data[type][id];
            DB.saveData(data);
            showMessage(`${type.slice(0, -1)} deleted.`, true);
            switchTab(type);
        }
        
        // --- School Management ---
        const schoolsList = document.getElementById('schools-list');
        const newSchoolName = document.getElementById('new-school-name');
        const addSchoolBtn = document.getElementById('add-school-btn');

        function renderSchools() {
            const data = DB.getData();
            schoolsList.innerHTML = '';
            if (Object.keys(data.schools).length === 0) {
                schoolsList.innerHTML = '<p class="text-gray-500 text-center">No schools created yet.</p>';
                return;
            }
            Object.values(data.schools).forEach(school => {
                const schoolEl = renderItem(school, 'schools', openEditModal, genericDelete);
                schoolsList.appendChild(schoolEl);
            });
        }
        addSchoolBtn.addEventListener('click', () => {
            const name = newSchoolName.value.trim();
            if (!name) return showMessage('School name cannot be empty.', true);
            let data = DB.getData();
            const id = `school_${Date.now()}`;
            data.schools[id] = { id, name };
            DB.saveData(data);
            showMessage('School added successfully!');
            newSchoolName.value = '';
            renderSchools();
        });

        // --- Course Management ---
        const courseSchoolSelect = document.getElementById('course-school-select');
        const coursesList = document.getElementById('courses-list');
        const newCourseName = document.getElementById('new-course-name');
        const addCourseBtn = document.getElementById('add-course-btn');
        
        function renderCourses() {
            const schoolId = courseSchoolSelect.value;
            coursesList.innerHTML = '';
            if (!schoolId) {
                 coursesList.innerHTML = '<p class="text-gray-500 text-center">Select a school to see its courses.</p>';
                 return;
            }
            const data = DB.getData();
            const schoolCourses = Object.values(data.courses).filter(c => c.schoolId === schoolId);
            if (schoolCourses.length === 0) {
                coursesList.innerHTML = '<p class="text-gray-500 text-center">No courses in this school yet.</p>';
            }
            schoolCourses.forEach(course => coursesList.appendChild(renderItem(course, 'courses', openEditModal, genericDelete)));
        }

        courseSchoolSelect.addEventListener('change', renderCourses);
        addCourseBtn.addEventListener('click', () => {
            const name = newCourseName.value.trim();
            const schoolId = courseSchoolSelect.value;
            if (!name || !schoolId) return showMessage('Course name and school are required.', true);
            let data = DB.getData();
            const id = `course_${Date.now()}`;
            data.courses[id] = { id, name, schoolId };
            DB.saveData(data);
            showMessage('Course added!');
            newCourseName.value = '';
            renderCourses();
        });

        // --- Task Management ---
        const taskSchoolSelect = document.getElementById('task-school-select');
        const taskCourseSelect = document.getElementById('task-course-select');
        const tasksList = document.getElementById('tasks-list');
        const newTaskName = document.getElementById('new-task-name');
        const newTaskValue = document.getElementById('new-task-value');
        const addTaskBtn = document.getElementById('add-task-btn');
        
        taskSchoolSelect.addEventListener('change', () => populateCourseSelect('task-course-select', 'task-school-select', renderTasks));
        taskCourseSelect.addEventListener('change', renderTasks);
        
        function renderTasks() {
            const courseId = taskCourseSelect.value;
            const remainingPointsDisplay = document.getElementById('course-remaining-points-display');
            tasksList.innerHTML = '';
            
            if (!courseId) {
                tasksList.innerHTML = '<p class="text-gray-500 text-center">Select a course to see its tasks.</p>';
                remainingPointsDisplay.textContent = '--';
                remainingPointsDisplay.className = 'text-2xl font-bold text-white';
                return;
            }

            const data = DB.getData();
            const courseTasks = Object.values(data.tasks).filter(t => t.courseId === courseId);
            
            const totalValue = courseTasks.reduce((sum, task) => sum + task.value, 0);
            const remaining = 100 - totalValue;
            
            remainingPointsDisplay.textContent = `${remaining} pts`;
            if (remaining < 0) {
                 remainingPointsDisplay.className = 'text-2xl font-bold text-red-400';
            } else if (remaining === 0) {
                 remainingPointsDisplay.className = 'text-2xl font-bold text-emerald-400';
            } else {
                 remainingPointsDisplay.className = 'text-2xl font-bold text-yellow-400';
            }

            if (courseTasks.length === 0) {
                 tasksList.innerHTML = '<p class="text-gray-500 text-center">No tasks in this course yet.</p>';
            } else {
                courseTasks.forEach(task => tasksList.appendChild(renderItem(task, 'tasks', openEditModal, genericDelete)));
            }
        }
        
        addTaskBtn.addEventListener('click', () => {
             const name = newTaskName.value.trim();
             const value = parseInt(newTaskValue.value, 10);
             const courseId = taskCourseSelect.value;

             if (!name || !courseId) return showMessage('Task name and course are required.', true);
             if (isNaN(value) || value < 1 || value > 100) return showMessage('Task value must be a number between 1 and 100.', true);
             
             const data = DB.getData();
             const courseTasks = Object.values(data.tasks).filter(t => t.courseId === courseId);
             const currentTotalValue = courseTasks.reduce((sum, task) => sum + task.value, 0);

             if (currentTotalValue + value > 100) {
                 return showMessage(`Adding this task would exceed the course total of 100 points. (Current: ${currentTotalValue}/100)`, true, 5000);
             }

             const id = `task_${Date.now()}`;
             data.tasks[id] = { id, name, courseId, value };
             DB.saveData(data);

             showMessage('Task added!');
             newTaskName.value = '';
             newTaskValue.value = '';
             renderTasks();
        });

        // --- Student Management ---
        const studentsList = document.getElementById('students-list');
        const studentModal = modals.student;
        
        function renderStudents() {
            const data = DB.getData();
            studentsList.innerHTML = '';
            if (Object.keys(data.students).length === 0) {
                studentsList.innerHTML = '<p class="text-gray-500 text-center">No students created yet.</p>';
                return;
            }
            Object.values(data.students).forEach(student => {
                 const div = document.createElement('div');
                 div.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center cursor-pointer hover:bg-gray-600';
                 div.onclick = () => openStudentModal(student.id);
                 const schoolName = data.schools[student.schoolId]?.name || 'N/A';
                 div.innerHTML = `<div><p class="font-semibold text-white">${student.name}</p><p class="text-sm text-gray-400">${schoolName}</p></div>`;
                 studentsList.appendChild(div);
            });
        }

        // --- Generic Dropdown Population ---
        function populateSchoolSelect(selectId, onChangeCallback) {
            const select = document.getElementById(selectId);
            const data = DB.getData();
            select.innerHTML = '<option value="">-- Select a School --</option>';
            Object.values(data.schools).forEach(s => select.innerHTML += `<option value="${s.id}">${s.name}</option>`);
            if (onChangeCallback) onChangeCallback();
        }

        function populateCourseSelect(courseSelectId, schoolSelectId, onChangeCallback) {
            const courseSelect = document.getElementById(courseSelectId);
            const schoolId = document.getElementById(schoolSelectId).value;
            const data = DB.getData();
            courseSelect.innerHTML = '<option value="">-- Select a Course --</option>';
            if (schoolId) {
                Object.values(data.courses).filter(c => c.schoolId === schoolId)
                      .forEach(c => courseSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`);
            }
            if (onChangeCallback) onChangeCallback();
        }

        // --- Student Modal Logic ---
        document.getElementById('show-add-student-modal-btn').addEventListener('click', () => openStudentModal());
        document.getElementById('cancel-student-btn').addEventListener('click', () => studentModal.classList.add('hidden'));
        document.getElementById('close-fullscreen-qr-btn').addEventListener('click', () => modals.fullscreenQr.classList.add('hidden'));


        function openStudentModal(studentId = null) {
            const isEditing = !!studentId;
            const data = DB.getData();
            const student = isEditing ? data.students[studentId] : null;

            document.getElementById('student-modal-title').textContent = isEditing ? `Edit ${student.name}` : 'Add New Student';
            document.getElementById('student-id-input').value = studentId || '';
            document.getElementById('student-name-input').value = student?.name || '';
            
            const studentSchoolSelect = document.getElementById('student-school-select');
            populateSchoolSelect('student-school-select', () => {
                 if (isEditing) studentSchoolSelect.value = student.schoolId;
                 populateStudentCoursesChecklist(student);
            });
            studentSchoolSelect.onchange = () => populateStudentCoursesChecklist(student);

            document.getElementById('student-qrcode-container').classList.toggle('hidden', !isEditing);
            document.getElementById('delete-student-btn').classList.toggle('hidden', !isEditing);
            
            if(isEditing) {
                const qrDiv = document.getElementById('student-qrcode-display');
                qrDiv.innerHTML = '';
                new QRCode(qrDiv, { text: student.id, width: 192, height: 192, colorDark: "#f0fdf4", colorLight: "#374151", correctLevel: QRCode.CorrectLevel.H });
            
                qrDiv.onclick = () => {
                    const canvas = qrDiv.querySelector('canvas');
                    if(canvas) {
                        document.getElementById('fullscreen-qr-image').src = canvas.toDataURL();
                        modals.fullscreenQr.classList.remove('hidden');
                    }
                };

                document.getElementById('share-qr-whatsapp-btn').onclick = () => {
                    const studentName = student.name;
                    const text = encodeURIComponent(`QR Code for student: ${studentName}. Please enlarge the QR code on your screen and take a screenshot to share.`);
                    const whatsappUrl = `https://wa.me/?text=${text}`;
                    window.open(whatsappUrl, '_blank');
                };

            }
            
            studentModal.classList.remove('hidden');
        }

        function populateStudentCoursesChecklist(student) {
            const schoolId = document.getElementById('student-school-select').value;
            const checklistDiv = document.getElementById('student-courses-checklist');
            const data = DB.getData();
            checklistDiv.innerHTML = '';
            
            if (!schoolId) return checklistDiv.innerHTML = '<p class="text-gray-500 text-sm">Please select a school first.</p>';
            
            const schoolCourses = Object.values(data.courses).filter(c => c.schoolId === schoolId);
            if (schoolCourses.length === 0) return checklistDiv.innerHTML = '<p class="text-gray-500 text-sm">No courses in this school.</p>';
            
            schoolCourses.forEach(course => {
                const isChecked = student?.courseIds.includes(course.id) || false;
                checklistDiv.innerHTML += `<label class="flex items-center space-x-3"><input type="checkbox" value="${course.id}" class="course-checkbox bg-gray-600 rounded" ${isChecked ? 'checked' : ''}><span class="text-gray-300">${course.name}</span></label>`;
            });
        }
        
        document.getElementById('save-student-btn').addEventListener('click', () => {
            const studentId = document.getElementById('student-id-input').value;
            const isEditing = !!studentId;
            const name = document.getElementById('student-name-input').value.trim();
            const schoolId = document.getElementById('student-school-select').value;
            const courseIds = Array.from(document.querySelectorAll('.course-checkbox:checked')).map(cb => cb.value);

            if (!name || !schoolId || courseIds.length === 0) return showMessage('Name, school, and at least one course are required.', true);
            
            let data = DB.getData();
            const id = isEditing ? studentId : `student_${Date.now()}`;
            
            data.students[id] = { id, name, schoolId, courseIds, grades: isEditing ? data.students[id].grades : [] };
            DB.saveData(data);
            showMessage(`Student ${isEditing ? 'updated' : 'created'} successfully!`);
            studentModal.classList.add('hidden');
            renderStudents();
        });

        document.getElementById('delete-student-btn').addEventListener('click', () => {
            const studentId = document.getElementById('student-id-input').value;
            const studentName = DB.getData().students[studentId].name;
            genericDelete(studentId, studentName, 'students');
            studentModal.classList.add('hidden');
        });

        // --- Edit Modal Logic (for School, Course, Task) ---
        function openEditModal(item, type) {
            document.getElementById('edit-modal-title').textContent = `Edit ${type.slice(0,-1)}`;
            document.getElementById('edit-item-id').value = item.id;
            document.getElementById('edit-item-type').value = type;
            document.getElementById('edit-item-name').value = item.name;

            const valueContainer = document.getElementById('edit-task-value-container');
            if (type === 'tasks') {
                document.getElementById('edit-item-value').value = item.value || '';
                valueContainer.classList.remove('hidden');
            } else {
                valueContainer.classList.add('hidden');
            }
            modals.edit.classList.remove('hidden');
        }

        document.getElementById('cancel-edit-btn').addEventListener('click', () => modals.edit.classList.add('hidden'));
        document.getElementById('save-edit-btn').addEventListener('click', () => {
            const id = document.getElementById('edit-item-id').value;
            const type = document.getElementById('edit-item-type').value;
            const name = document.getElementById('edit-item-name').value.trim();
            if (!name) return showMessage('Name cannot be empty.', true);
            
            let data = DB.getData();
            
            if (type === 'tasks') {
                const value = parseInt(document.getElementById('edit-item-value').value, 10);
                if (isNaN(value) || value < 1 || value > 100) return showMessage('Task value must be a number between 1 and 100.', true);

                const taskBeingEdited = data.tasks[id];
                const courseId = taskBeingEdited.courseId;
                const otherTasksInCourse = Object.values(data.tasks).filter(t => t.courseId === courseId && t.id !== id);
                const otherTasksTotalValue = otherTasksInCourse.reduce((sum, task) => sum + task.value, 0);

                if (otherTasksTotalValue + value > 100) {
                    return showMessage(`Updating this task would exceed the course total of 100 points. (Other tasks total: ${otherTasksTotalValue}/100)`, true, 5000);
                }
                
                data.tasks[id].name = name;
                data.tasks[id].value = value;
            } else {
                data[type][id].name = name;
            }

            DB.saveData(data);
            showMessage('Item updated!');
            modals.edit.classList.add('hidden');
            switchTab(type);
        });

        // --- QR Scanner & Grading Logic ---
        let html5QrCode = null;
        const startScanBtn = document.getElementById('start-scan-btn');
        const scanStatus = document.getElementById('scan-status');

        function onScanSuccess(decodedText) {
            stopScan();
            const student = DB.getData().students[decodedText];
            if (student) handleValidStudent(student);
            else showMessage("Unrecognized QR code.", true, 4000);
        }
        function onScanFailure(error) { /* Ignore */ }

        function startScan() {
            if (html5QrCode && html5QrCode.isScanning) return;
            if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
            
            startScanBtn.textContent = 'Starting...'; startScanBtn.disabled = true;
            scanStatus.textContent = "Requesting Camera...";
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                .then(() => {
                    startScanBtn.textContent = 'Stop Scan'; startScanBtn.disabled = false;
                    scanStatus.textContent = "Scanning...";
                })
                .catch(err => {
                    scanStatus.textContent = "Camera Error";
                    showMessage(`Camera Error: ${err}`, true, 5000);
                    startScanBtn.textContent = 'Start Scan'; startScanBtn.disabled = false;
                });
        }

        function stopScan() {
            if (html5QrCode && html5QrCode.isScanning) html5QrCode.stop().catch(err => {});
            startScanBtn.textContent = 'Start Scan'; startScanBtn.disabled = false;
            scanStatus.textContent = "Scanner is off.";
        }
        
        startScanBtn.addEventListener('click', () => (html5QrCode && html5QrCode.isScanning) ? stopScan() : startScan());

        function handleValidStudent(student) {
            document.getElementById('grade-student-name').textContent = student.name;
            document.getElementById('grade-student-id').value = student.id;
            
            const taskSelect = document.getElementById('task-select');
            const data = DB.getData();
            taskSelect.innerHTML = '<option value="">-- Select a Task --</option>';
            student.courseIds.forEach(courseId => {
                const courseName = data.courses[courseId]?.name || 'Unknown Course';
                Object.values(data.tasks).filter(t => t.courseId === courseId)
                      .forEach(task => taskSelect.innerHTML += `<option value="${task.id}">${courseName} - ${task.name}</option>`);
            });
            updateGradeMaxValue(); // Clear max value initially
            document.getElementById('grade-value').value = '';
            modals.setGrade.classList.remove('hidden');
        }
        
        const taskSelect = document.getElementById('task-select');
        taskSelect.addEventListener('change', updateGradeMaxValue);
        
        function updateGradeMaxValue() {
            const taskId = taskSelect.value;
            const gradeMaxValueSpan = document.getElementById('grade-max-value');
            const gradeValueInput = document.getElementById('grade-value');
            if (!taskId) {
                gradeMaxValueSpan.textContent = '';
                gradeValueInput.max = null;
                return;
            }
            const task = DB.getData().tasks[taskId];
            gradeMaxValueSpan.textContent = `(out of ${task.value} pts)`;
            gradeValueInput.max = task.value;
        }

        document.getElementById('cancel-grade-btn').addEventListener('click', () => modals.setGrade.classList.add('hidden'));
        
        const saveGradeBtn = document.getElementById('save-grade-btn');
        saveGradeBtn.addEventListener('click', () => {
            const studentId = document.getElementById('grade-student-id').value;
            const taskId = document.getElementById('task-select').value;
            const valueStr = document.getElementById('grade-value').value;
            
            if (!taskId || valueStr === '') return showMessage('Please select a task and enter a grade.', true);
            
            const value = parseFloat(valueStr);
            const data = DB.getData();
            const task = data.tasks[taskId];

            if (isNaN(value) || value < 0) return showMessage('Grade must be a positive number.', true);
            if (value > task.value) return showMessage(`Grade cannot be higher than the task value of ${task.value}.`, true);
            
            const gradeIndex = data.students[studentId].grades.findIndex(g => g.taskId === taskId);

            if (gradeIndex > -1) {
                // Grade exists, show confirmation modal
                const oldGrade = data.students[studentId].grades[gradeIndex];
                document.getElementById('old-grade-value').textContent = oldGrade.value;
                document.getElementById('old-grade-date').textContent = `Graded on: ${new Date(oldGrade.date).toLocaleString('es-MX')}`;
                document.getElementById('new-grade-value').textContent = value;
                
                const confirmBtn = document.getElementById('confirm-update-btn');
                confirmBtn.dataset.studentId = studentId;
                confirmBtn.dataset.gradeIndex = gradeIndex;
                confirmBtn.dataset.newValue = value;

                modals.setGrade.classList.add('hidden');
                modals.confirmGradeUpdate.classList.remove('hidden');
            } else {
                // New grade, save directly
                data.students[studentId].grades.push({ taskId, value, date: new Date().toISOString() });
                DB.saveData(data);
                modals.setGrade.classList.add('hidden');
                showMessage('Grade saved successfully!');
            }
        });
        
        document.getElementById('cancel-update-btn').addEventListener('click', () => {
            modals.confirmGradeUpdate.classList.add('hidden');
        });

        document.getElementById('confirm-update-btn').addEventListener('click', (e) => {
            const { studentId, gradeIndex, newValue } = e.target.dataset;
            let data = DB.getData();
            data.students[studentId].grades[gradeIndex].value = parseFloat(newValue);
            data.students[studentId].grades[gradeIndex].date = new Date().toISOString();
            DB.saveData(data);
            
            modals.confirmGradeUpdate.classList.add('hidden');
            showMessage('Grade updated successfully!');
        });
        
        // --- Manual Student Selection Logic ---
        let manualSelectMode = 'grading'; // 'grading' or 'reporting'

        document.getElementById('manual-select-btn').addEventListener('click', () => {
            stopScan();
            manualSelectMode = 'grading';
            populateManualSelectList();
            document.getElementById('student-search-input').value = '';
            modals.manualSelect.classList.remove('hidden');
        });
        
        document.getElementById('manual-select-report-btn').addEventListener('click', () => {
            stopReportScan();
            manualSelectMode = 'reporting';
            populateManualSelectList();
            document.getElementById('student-search-input').value = '';
            modals.manualSelect.classList.remove('hidden');
        });

        document.getElementById('close-manual-select-modal').addEventListener('click', () => modals.manualSelect.classList.add('hidden'));

        function populateManualSelectList(searchTerm = '') {
            const listDiv = document.getElementById('manual-student-list');
            const data = DB.getData();
            listDiv.innerHTML = '';
            const lowerCaseSearch = searchTerm.toLowerCase();

            const filtered = Object.values(data.students).filter(s => s.name.toLowerCase().includes(lowerCaseSearch));

            if (filtered.length === 0) return listDiv.innerHTML = '<p class="text-gray-500 text-center">No students found.</p>';
            
            filtered.forEach(student => {
                const schoolName = data.schools[student.schoolId]?.name || 'N/A';
                const div = document.createElement('div');
                div.className = 'manual-student-item bg-gray-700 p-4 rounded-lg hover:bg-gray-600 cursor-pointer';
                div.dataset.id = student.id;
                div.innerHTML = `<p class="font-semibold text-white pointer-events-none">${student.name}</p><p class="text-sm text-gray-400 pointer-events-none">${schoolName}</p>`;
                listDiv.appendChild(div);
            });
        }
        
        document.getElementById('student-search-input').addEventListener('input', e => populateManualSelectList(e.target.value));
        
        document.getElementById('manual-student-list').addEventListener('click', e => {
            const item = e.target.closest('.manual-student-item');
            if (item) {
                const student = DB.getData().students[item.dataset.id];
                if (student) {
                    modals.manualSelect.classList.add('hidden');
                    if (manualSelectMode === 'grading') {
                        handleValidStudent(student);
                    } else { // reporting
                        renderStudentReport(student.id);
                    }
                }
            }
        });

        // --- Grades Dashboard Logic ---
        const gradesSchoolSelect = document.getElementById('grades-school-select');
        const gradesCourseSelect = document.getElementById('grades-course-select');
        
        gradesSchoolSelect.addEventListener('change', () => {
            populateCourseSelect('grades-course-select', 'grades-school-select', renderGradesTable);
        });
        gradesCourseSelect.addEventListener('change', renderGradesTable);

        function renderGradesTable() {
            const courseId = gradesCourseSelect.value;
            const tableHead = document.getElementById('grades-table-head');
            const tableBody = document.getElementById('grades-table-body');
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';

            if (!courseId) return;

            const data = DB.getData();
            const courseTasks = Object.values(data.tasks).filter(t => t.courseId === courseId);
            const enrolledStudents = Object.values(data.students).filter(s => s.courseIds.includes(courseId));
            
            // Render Header
            let headerRow = '<tr><th>Student Name</th>';
            courseTasks.forEach(task => headerRow += `<th>${task.name} (${task.value}pts)</th>`);
            headerRow += '<th>Total</th><th>Missing Pts</th><th>Needed for 100</th></tr>';
            tableHead.innerHTML = headerRow;

            // Render Body
            enrolledStudents.forEach(student => {
                // --- Pre-calculate totals to determine row color ---
                let totalPoints = 0;
                let missingPoints = 0;
                courseTasks.forEach(task => {
                    const grade = student.grades.find(g => g.taskId === task.id);
                    if (grade) {
                        totalPoints += grade.value;
                    } else {
                        missingPoints += task.value;
                    }
                });

                // --- Determine row color based on total points ---
                let rowBgClass = 'bg-gray-700'; // Default for < 60
                if (totalPoints >= 80) {
                    rowBgClass = 'bg-green-800'; // Green for >= 80
                } else if (totalPoints >= 60) {
                    rowBgClass = 'bg-blue-800'; // Blue for 60-79.9
                }

                // --- Build row HTML with color class on each cell ---
                let bodyRow = `<tr><td class="font-semibold text-white ${rowBgClass}">${student.name}</td>`;
                
                courseTasks.forEach(task => {
                    const grade = student.grades.find(g => g.taskId === task.id);
                    if (grade) {
                        bodyRow += `<td class="${rowBgClass}">${grade.value}</td>`;
                    } else {
                        bodyRow += `<td class="missing-grade ${rowBgClass}">—</td>`;
                    }
                });
                
                const neededFor100 = 100 - totalPoints;
                bodyRow += `<td class="font-bold text-emerald-400 ${rowBgClass}">${totalPoints.toFixed(2)}</td>`;
                bodyRow += `<td class="font-bold text-yellow-400 ${rowBgClass}">${missingPoints}</td>`;
                bodyRow += `<td class="font-bold text-blue-400 ${rowBgClass}">${neededFor100 > 0 ? neededFor100.toFixed(2) : 0}</td>`;
                bodyRow += '</tr>';
                tableBody.innerHTML += bodyRow;
            });
        }

        document.getElementById('export-csv-btn').addEventListener('click', () => {
            const table = document.getElementById('grades-table');
            const courseSelect = document.getElementById('grades-course-select');
            const courseName = courseSelect.options[courseSelect.selectedIndex]?.text || 'grades';
            
            if (table.rows.length <= 1) {
                return showMessage('No data in the table to export.', true);
            }

            // BOM for UTF-8 Excel compatibility
            let csvContent = '\uFEFF'; 
            
            const rows = table.querySelectorAll("tr");
            
            rows.forEach(row => {
                const rowData = [];
                row.querySelectorAll("th, td").forEach(cell => {
                    let cellText = cell.innerText;
                    
                    // Replace the em dash for missing grades with an empty string
                    if (cellText === '—') {
                        cellText = '';
                    }

                    // Escape double quotes by doubling them as per CSV standard
                    const escapedText = cellText.replace(/"/g, '""');
                    
                    // Enclose each field in double quotes to handle commas, newlines, etc.
                    rowData.push(`"${escapedText}"`);
                });
                csvContent += rowData.join(",") + "\r\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            const date = new Date().toISOString().slice(0, 10);
            link.setAttribute("href", url);
            link.setAttribute("download", `${courseName.replace(/\s+/g, '_')}_${date}.csv`);
            document.body.appendChild(link);

            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showMessage('Grades exported to CSV!');
        });

        // --- Student Report Logic ---
        let reportHtml5QrCode = null;
        const startReportScanBtn = document.getElementById('start-report-scan-btn');
        const reportScanStatus = document.getElementById('report-scan-status');

        function onReportScanSuccess(decodedText) {
            stopReportScan();
            const student = DB.getData().students[decodedText];
            if (student) {
                renderStudentReport(student.id);
            } else {
                showMessage("Unrecognized QR code.", true, 4000);
            }
        }

        function startReportScan() {
            if (reportHtml5QrCode && reportHtml5QrCode.isScanning) return;
            if (!reportHtml5QrCode) reportHtml5QrCode = new Html5Qrcode("report-reader");
            
            startReportScanBtn.textContent = 'Starting...'; startReportScanBtn.disabled = true;
            reportScanStatus.textContent = "Requesting Camera...";
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
            reportHtml5QrCode.start({ facingMode: "environment" }, config, onReportScanSuccess, (err) => {})
                .then(() => {
                    startReportScanBtn.textContent = 'Stop Scan'; startReportScanBtn.disabled = false;
                    reportScanStatus.textContent = "Scanning...";
                })
                .catch(err => {
                    reportScanStatus.textContent = "Camera Error";
                    showMessage(`Camera Error: ${err}`, true, 5000);
                    startReportScanBtn.textContent = 'Scan Student QR for Report'; startReportScanBtn.disabled = false;
                });
        }

        function stopReportScan() {
            if (reportHtml5QrCode && reportHtml5QrCode.isScanning) reportHtml5QrCode.stop().catch(err => {});
            startReportScanBtn.textContent = 'Scan Student QR for Report'; startReportScanBtn.disabled = false;
            reportScanStatus.textContent = "Scanner is off.";
        }
        
        startReportScanBtn.addEventListener('click', () => (reportHtml5QrCode && reportHtml5QrCode.isScanning) ? stopReportScan() : startReportScan());

        function renderStudentReport(studentId) {
            document.getElementById('report-scanner-view').classList.add('hidden');
            const reportCardView = document.getElementById('report-card-view');
            reportCardView.classList.remove('hidden');
            
            const data = DB.getData();
            const student = data.students[studentId];
            let html = `<h2 class="text-2xl font-bold text-white mb-4">Report for <span class="text-teal-400">${student.name}</span></h2>`;

            student.courseIds.forEach(courseId => {
                const course = data.courses[courseId];
                if (!course) return;

                const courseTasks = Object.values(data.tasks).filter(t => t.courseId === courseId);
                let totalPoints = 0;
                let missingPoints = 0;

                html += `<div class="bg-gray-900 p-4 rounded-lg mb-4">`;
                html += `<h3 class="text-xl font-semibold text-white mb-2">${course.name}</h3>`;
                
                let taskListHtml = '<ul class="space-y-2">';
                courseTasks.forEach(task => {
                    const grade = student.grades.find(g => g.taskId === task.id);
                    if (grade) {
                        taskListHtml += `<li class="flex justify-between items-center"><span>${task.name}</span> <span class="font-semibold text-emerald-400">${grade.value} / ${task.value}</span></li>`;
                        totalPoints += grade.value;
                    } else {
                        taskListHtml += `<li class="flex justify-between items-center"><span>${task.name}</span> <span class="font-semibold text-red-400">Missing / ${task.value}</span></li>`;
                        missingPoints += task.value;
                    }
                });
                taskListHtml += '</ul>';
                
                html += taskListHtml;
                html += `<div class="mt-4 pt-4 border-t border-gray-700 flex justify-around text-center">`;
                html += `<div><p class="text-sm text-gray-400">Total Points</p><p class="text-lg font-bold text-emerald-400">${totalPoints.toFixed(2)}</p></div>`;
                html += `<div><p class="text-sm text-gray-400">Missing Points</p><p class="text-lg font-bold text-yellow-400">${missingPoints}</p></div>`;
                html += `</div></div>`;
            });

            reportCardView.innerHTML = html;
        }

        // --- Data Import/Export/Clear Logic ---
        document.getElementById('export-data-btn').addEventListener('click', () => {
            const data = DB.getData();
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            const date = new Date().toISOString().slice(0, 10);
            a.href = url;
            a.download = `grading_system_backup_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage('Data exported successfully!');
        });

        const importFileInput = document.getElementById('import-file-input');
        document.getElementById('import-data-btn').addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm('Are you sure you want to import this file? This will permanently overwrite ALL existing data.')) {
                event.target.value = ''; // Reset file input
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    // Basic validation to ensure it's a compatible file
                    if (importedData.schools && importedData.courses && importedData.tasks && importedData.students) {
                        DB.saveData(importedData);
                        showMessage('Data imported successfully! Refreshing view...');
                        const activeTab = document.querySelector('.tab-btn.active')?.dataset.tab || 'schools';
                        switchTab(activeTab);
                    } else {
                        throw new Error('Invalid data structure.');
                    }
                } catch (error) {
                    showMessage('Import failed. The file is not valid JSON or has an incorrect format.', true);
                } finally {
                    event.target.value = ''; // Reset file input
                }
            };
            reader.readAsText(file);
        });
        
        document.getElementById('clear-data-btn').addEventListener('click', () => {
            if (confirm('Are you absolutely sure you want to delete all data? This action cannot be undone. (1/3)')) {
                if (confirm('This will delete all schools, courses, tasks, students, and grades permanently. Are you certain? (2/3)')) {
                    if (confirm('FINAL CONFIRMATION: Delete all data now? (3/3)')) {
                        DB.clearData();
                        showMessage('All data has been cleared.', true);
                        // Refresh the current view
                        const activeTab = document.querySelector('.tab-btn.active')?.dataset.tab || 'schools';
                        switchTab(activeTab);
                    }
                }
            }
        });


        // --- App Initialization ---
        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const action = btn.dataset.action;
                showSection(action);
                if (action === 'dashboard') switchTab('schools');
                if (action === 'grades-dashboard') populateSchoolSelect('grades-school-select', () => populateCourseSelect('grades-course-select', 'grades-school-select', renderGradesTable));
                if (action === 'student-report') {
                     document.getElementById('report-scanner-view').classList.remove('hidden');
                     const reportCardView = document.getElementById('report-card-view');
                     reportCardView.classList.add('hidden');
                     if(reportCardView) {
                       reportCardView.innerHTML = '';
                     }
                }
            });
        });
        document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', showMainMenu));

        checkAuth();

    </script>
</body>
</html>

