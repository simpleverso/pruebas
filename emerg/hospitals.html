<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EOC - Hospital Status</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        :root {
            --primary-bg: #111827; --secondary-bg: #1f2937; --tertiary-bg: #374151;
            --accent-color: #3b82f6; --text-primary: #f9fafb; --text-secondary: #d1d5db;
        }
        body { background-color: var(--primary-bg); color: var(--text-primary); font-family: 'Inter', sans-serif; }
        .sidebar { background-color: var(--secondary-bg); }
        .nav-link { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 0.5rem; color: var(--text-secondary); transition: all 0.2s; }
        .nav-link:hover { background-color: var(--tertiary-bg); color: var(--text-primary); }
        .nav-link.active { background-color: var(--accent-color); color: white; font-weight: 600; }
        .header { background-color: var(--secondary-bg); border-bottom: 1px solid var(--tertiary-bg); }
        #map { height: 100%; width: 100%; background-color: #333; border-radius: 0.5rem; }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: var(--secondary-bg); margin: 5% auto; padding: 2rem;
            border: 1px solid var(--tertiary-bg); width: 90%;
            border-radius: 0.75rem;
        }
        .service-tag { background-color: var(--tertiary-bg); }
        .hospital-label {
            background-color: transparent;
            border: none;
            box-shadow: none;
            color: #f9fafb;
            font-weight: bold;
            font-size: 12px;
            text-shadow: 1px 1px 2px var(--primary-bg);
        }
        .leaflet-popup-content-wrapper {
            background: var(--secondary-bg);
            color: var(--text-primary);
            border-radius: 8px;
        }
        .leaflet-popup-content {
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            line-height: 1.6;
        }
        .leaflet-popup-tip {
            background: var(--secondary-bg);
        }
    </style>
</head>
<body>
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 sidebar flex-shrink-0 p-4 hidden md:block">
            <div class="flex items-center mb-8">
                <i data-lucide="siren" class="w-8 h-8 text-red-500 mr-2"></i>
                <h1 class="text-xl font-bold text-white">EOC Platform</h1>
            </div>
            <nav class="space-y-2">
                <a href="./dashboard.html" class="nav-link"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard</a>
                <a href="./map.html" class="nav-link"><i data-lucide="map" class="w-5 h-5 mr-3"></i> GIS & Mapping</a>
                <a href="./resources.html" class="nav-link"><i data-lucide="users" class="w-5 h-5 mr-3"></i> Resource Mgmt</a>
                <a href="./humanitarian.html" class="nav-link"><i data-lucide="heart-handshake" class="w-5 h-5 mr-3"></i> Humanitarian</a>
                <a href="#" class="nav-link active"><i data-lucide="hospital" class="w-5 h-5 mr-3"></i> Hospital Status</a>
                <a href="./requests.html" class="nav-link"><i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i> Needs & Requests</a>
                <a href="./communications.html" class="nav-link"><i data-lucide="message-square" class="w-5 h-5 mr-3"></i> Communications</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col">
            <header class="header p-4 flex justify-between items-center flex-shrink-0">
                <h2 class="text-2xl font-semibold">Hospital Coordination</h2>
                <button id="addHospitalBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Add Hospital
                </button>
            </header>
            
            <div class="flex flex-col lg:flex-row gap-6 p-6 flex-1 min-h-0">
                <div class="flex flex-col gap-4 lg:w-1/3 lg:max-w-md h-1/2 lg:h-full">
                    <h3 class="text-xl font-semibold">Hospital Directory</h3>
                    <div id="hospitalList" class="space-y-4 overflow-y-auto flex-1 pr-2">
                        <!-- Hospital cards will be injected here -->
                    </div>
                </div>
                <div class="flex-1 h-1/2 lg:h-full">
                    <div id="map"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Hospital Modal -->
    <div id="hospitalModal" class="modal">
        <div class="modal-content max-w-3xl">
            <h2 class="text-xl font-semibold mb-4">Add Hospital</h2>
            <form id="hospitalForm">
                <input type="hidden" id="hospitalId"><input type="hidden" id="hospitalLat"><input type="hidden" id="hospitalLng">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 max-h-[75vh] overflow-y-auto pr-2">
                    <!-- Column 1 -->
                    <div>
                        <div class="mb-4">
                            <label for="hospitalName" class="block mb-2 text-sm font-medium">Hospital Name</label>
                            <input type="text" id="hospitalName" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5" required>
                        </div>
                        <div class="mb-4">
                            <label for="hospitalType" class="block mb-2 text-sm font-medium">Type</label>
                            <select id="hospitalType" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5">
                                <option value="General">General</option><option value="Trauma Center">Trauma Center</option><option value="Pediatric">Pediatric</option><option value="Specialty">Specialty</option>
                            </select>
                        </div>
                         <div class="mb-4">
                            <label for="hospitalStatus" class="block mb-2 text-sm font-medium">Operational Status</label>
                            <select id="hospitalStatus" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5">
                                <option value="Accepting">Accepting</option><option value="Diversion">On Diversion</option><option value="Full">At Capacity</option><option value="Closed">Closed</option>
                                <option value="Disabled">Disabled (Emergency)</option>
                            </select>
                        </div>
                        <div id="transferNotesContainer" class="mb-4 hidden">
                            <label for="transferNotes" class="block mb-2 text-sm font-medium text-yellow-400">Patient Transfer Notes</label>
                            <textarea id="transferNotes" rows="3" class="bg-gray-700 border border-yellow-500 text-white text-sm rounded-lg block w-full p-2.5" placeholder="e.g., Patients transferred to Hospital General..."></textarea>
                        </div>
                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-medium">Location</label>
                            <button type="button" id="setLocationBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg">Set Location on Map</button>
                             <p id="location-feedback" class="text-sm h-4 mt-2 text-green-400"></p>
                        </div>
                        <div>
                            <label for="newService" class="block mb-2 text-sm font-medium">Services Offered</label>
                            <div class="flex">
                                <input type="text" id="newService" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-l-lg block w-full p-2.5" placeholder="e.g., Surgery, X-Ray">
                                <button type="button" id="addServiceBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2.5 rounded-r-lg">Add</button>
                            </div>
                            <div id="servicesList" class="mt-2 flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                    <!-- Column 2 -->
                    <div>
                        <h4 class="font-semibold mb-2">Bed Capacity</h4>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 bg-gray-800 p-4 rounded-lg">
                            <label class="text-sm font-medium col-span-2">Emergency Room</label>
                            <input type="number" id="erBedsTotal" class="bg-gray-700 border border-gray-600 rounded p-2" placeholder="Total" min="0">
                            <input type="number" id="erBedsAvailable" class="bg-gray-700 border border-gray-600 rounded p-2" placeholder="Available" min="0">
                            
                            <label class="text-sm font-medium col-span-2 mt-2">ICU</label>
                            <input type="number" id="icuBedsTotal" class="bg-gray-700 border border-gray-600 rounded p-2" placeholder="Total" min="0">
                            <input type="number" id="icuBedsAvailable" class="bg-gray-700 border border-gray-600 rounded p-2" placeholder="Available" min="0">

                            <label class="text-sm font-medium col-span-2 mt-2">Surgical</label>
                            <input type="number" id="surBedsTotal" class="bg-gray-700 border border-gray-600 rounded p-2" placeholder="Total" min="0">
                            <input type="number" id="surBedsAvailable" class="bg-gray-700 border border-gray-600 rounded p-2" placeholder="Available" min="0">

                             <label class="text-sm font-medium col-span-2 mt-2">General Ward</label>
                            <input type="number" id="genBedsTotal" class="bg-gray-700 border border-gray-600 rounded p-2" placeholder="Total" min="0">
                            <input type="number" id="genBedsAvailable" class="bg-gray-700 border border-gray-600 rounded p-2" placeholder="Available" min="0">
                        </div>
                        <h4 class="font-semibold mb-2 mt-4">Staffing</h4>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 bg-gray-800 p-4 rounded-lg">
                            <label class="text-sm font-medium">Doctors</label>
                            <input type="number" id="staffDoctors" class="bg-gray-700 border border-gray-600 rounded p-2" placeholder="Count" min="0">
                            
                            <label class="text-sm font-medium">Specialists</label>
                            <input type="number" id="staffSpecialists" class="bg-gray-700 border border-gray-600 rounded p-2" placeholder="Count" min="0">

                            <label class="text-sm font-medium col-span-2 mt-2">Nurses</label>
                            <input type="number" id="staffNurses" class="bg-gray-700 border border-gray-600 rounded p-2 col-span-2" placeholder="Count" min="0">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-600">
                    <button type="button" class="close-modal-btn py-2 px-4 rounded-lg text-gray-300 hover:bg-gray-600">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save Hospital</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal" style="z-index: 1050;">
        <div class="modal-content max-w-sm">
            <h2 id="confirmationMessage" class="text-lg font-semibold mb-6 text-center">Are you sure?</h2>
            <div class="flex justify-center space-x-4">
                <button id="cancelBtn" class="py-2 px-6 rounded-lg text-gray-300 hover:bg-gray-600 border border-gray-600">Cancel</button>
                <button id="confirmBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Confirm</button>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        lucide.createIcons();
        const map = L.map('map').setView([16.43, -95.02], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO', subdomains: 'abcd', maxZoom: 20
        }).addTo(map);

        let hospitalsData = [
            { id: 1, name: 'Hospital General Dr. Macedonio Benítez Fuentes', type: 'General', lat: 16.435, lng: -95.015, status: 'Accepting', beds: { er: {t:20, a:12}, icu: {t:8, a:3}, sur: {t:10,a:8}, gen: {t:50,a:45}}, staff: { doctors: 15, specialists: 5, nurses: 30 }, services: ['Surgery', 'Emergency', 'X-Ray', 'Pharmacy'], transferNotes: '' },
            { id: 2, name: 'IMSS Juchitán', type: 'General', lat: 16.44, lng: -95.022, status: 'Diversion', beds: { er: {t:15, a:2}, icu: {t:5, a:0}, sur: {t:5,a:1}, gen: {t:30,a:28}}, staff: { doctors: 10, specialists: 2, nurses: 25 }, services: ['Cardiology', 'Emergency'], transferNotes: '' },
            { id: 3, name: 'Hospital Civil "Dr. Aurelio Valdivieso"', type: 'Trauma Center', lat: 16.425, lng: -95.025, status: 'Full', beds: { er: {t:25, a:0}, icu: {t:10, a:0}, sur: {t:15,a:1}, gen: {t:60,a:58}}, staff: { doctors: 25, specialists: 12, nurses: 50 }, services: ['Trauma', 'Surgery', 'Emergency'], transferNotes: ''},
            { id: 4, name: 'Hospital de la Comunidad Istmo', type: 'Specialty', lat: 16.42, lng: -95.03, status: 'Disabled', beds: { er: {t:10, a:0}, icu: {t:4, a:0}, sur: {t:5,a:0}, gen: {t:20,a:0}}, staff: { doctors: 0, specialists: 0, nurses: 0 }, services: ['Pediatric'], transferNotes: 'Structural damage reported. All patients transferred to Hospital General Dr. Macedonio Benítez Fuentes.' }
        ];
        let tempServices = [];
        
        const hospitalModal = document.getElementById('hospitalModal');
        const hospitalForm = document.getElementById('hospitalForm');
        
        const serviceIcons = {
            'Surgery': 'scalpel', 'Emergency': 'siren', 'X-Ray': 'x', 
            'Pharmacy': 'pilule', 'Cardiology': 'heart-pulse', 'Pediatric': 'baby', 
            'Trauma': 'heart-crack', 'Oncology': 'ribbon', 'Neurology': 'brain'
        };

        function getIconForService(serviceName) {
            const lowerCaseService = serviceName.toLowerCase();
            for (const key in serviceIcons) {
                if (lowerCaseService.includes(key.toLowerCase())) {
                    return serviceIcons[key];
                }
            }
            return 'stethoscope'; // Default icon
        }

        function renderHospitalList() {
            const listEl = document.getElementById('hospitalList');
            listEl.innerHTML = '';
            if (hospitalsData.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400">No hospitals registered.</p>'; return;
            }
            hospitalsData.forEach(h => {
                let statusColor = 'bg-gray-500';
                if (h.status === 'Accepting') statusColor = 'bg-green-500';
                else if (h.status === 'Diversion') statusColor = 'bg-yellow-500';
                else if (h.status === 'Full' || h.status === 'Disabled') statusColor = 'bg-red-500';
                
                let cardContent = '';
                if (h.status === 'Disabled') {
                    cardContent = `
                        <div class="mt-4 text-sm space-y-3">
                            <div class="p-3 bg-red-900/50 border border-red-700 rounded-lg">
                                <p class="font-bold text-red-300">Patient Transfer Info:</p>
                                <p class="text-red-200">${h.transferNotes || 'No details provided.'}</p>
                            </div>
                        </div>`;
                } else {
                    const totalBeds = (h.beds.er.t || 0) + (h.beds.icu.t || 0) + (h.beds.sur.t || 0) + (h.beds.gen.t || 0);
                    const availableBeds = (h.beds.er.a || 0) + (h.beds.icu.a || 0) + (h.beds.sur.a || 0) + (h.beds.gen.a || 0);
                    const occupancy = totalBeds > 0 ? Math.round(((totalBeds - availableBeds) / totalBeds) * 100) : 0;
                    let progressColor = 'bg-green-500';
                    if (occupancy > 85) progressColor = 'bg-red-500';
                    else if (occupancy > 60) progressColor = 'bg-yellow-500';
                    
                    let servicesHtml = h.services.map(service => {
                        const iconName = getIconForService(service);
                        return `<span class="inline-flex items-center gap-1.5 py-0.5 px-2 rounded text-xs bg-gray-700 text-gray-300"><i data-lucide="${iconName}" class="w-3.5 h-3.5"></i>${service}</span>`;
                    }).join('');

                    cardContent = `
                        <div class="mt-4 text-sm space-y-3">
                            <div>
                                <div class="flex justify-between mb-1">
                                    <p><strong>Bed Occupancy:</strong></p>
                                    <p>${availableBeds} / ${totalBeds}</p>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2.5">
                                    <div class="${progressColor} h-2.5 rounded-full" style="width: ${occupancy}%"></div>
                                </div>
                            </div>
                            <div>
                                <p class="font-semibold mb-2">Services:</p>
                                <div class="flex flex-wrap gap-2">${servicesHtml || '<span class="text-gray-400">N/A</span>'}</div>
                            </div>
                            <div>
                                <p class="font-semibold mb-2">Staff:</p>
                                <div class="flex justify-around text-center text-xs p-2 bg-gray-900/50 rounded-lg">
                                    <div class="flex flex-col items-center">
                                        <i data-lucide="stethoscope" class="w-5 h-5 mb-1 text-gray-300"></i>
                                        <span class="font-bold text-base">${h.staff?.doctors || 0}</span>
                                        <span class="text-gray-400">Doctors</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <i data-lucide="user-check" class="w-5 h-5 mb-1 text-gray-300"></i>
                                        <span class="font-bold text-base">${h.staff?.specialists || 0}</span>
                                        <span class="text-gray-400">Specialists</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <i data-lucide="users" class="w-5 h-5 mb-1 text-gray-300"></i>
                                        <span class="font-bold text-base">${h.staff?.nurses || 0}</span>
                                        <span class="text-gray-400">Nurses</span>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }

                listEl.innerHTML += `
                    <div class="p-4 rounded-lg bg-gray-800 border border-gray-700">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-lg">${h.name}</h4>
                                <p class="text-sm text-gray-400">${h.type}</p>
                            </div>
                            <span class="text-xs font-bold py-1 px-2 rounded-full ${statusColor}">${h.status}</span>
                        </div>
                        ${cardContent}
                        <div class="mt-4 flex space-x-2">
                            <button onclick="editHospital(${h.id})" class="text-xs bg-blue-600 hover:bg-blue-700 py-1 px-3 rounded">Edit</button>
                            <button onclick="deleteHospital(${h.id})" class="text-xs bg-red-600 hover:bg-red-700 py-1 px-3 rounded">Delete</button>
                             <button onclick="centerMapOn(${h.lat}, ${h.lng})" class="text-xs bg-gray-600 hover:bg-gray-700 py-1 px-3 rounded">View on Map</button>
                        </div>
                    </div>
                `;
            });
        }
        
        function getIconForHospital(hospital) {
            if (hospital.status === 'Disabled') {
                return L.icon({ iconUrl: 'https://placehold.co/32x32/4b5563/FFFFFF?text=X', iconSize: [32, 32], className: 'blinking' });
            }
            const totalBeds = (hospital.beds.er.t || 0) + (hospital.beds.icu.t || 0) + (hospital.beds.sur.t || 0) + (hospital.beds.gen.t || 0);
            const availableBeds = (hospital.beds.er.a || 0) + (hospital.beds.icu.a || 0) + (hospital.beds.sur.a || 0) + (hospital.beds.gen.a || 0);
            const occupancy = totalBeds > 0 ? ((totalBeds - availableBeds) / totalBeds) * 100 : 0;
            
            let color = '22c55e'; // green
            if (occupancy > 85) color = 'ef4444'; // red
            else if (occupancy > 60) color = 'f59e0b'; // yellow
            
            return L.icon({ iconUrl: `https://placehold.co/32x32/${color}/FFFFFF?text=H`, iconSize: [32, 32] });
        }

        function renderHospitalMarkers() {
            map.eachLayer(l => { if (l instanceof L.Marker || l instanceof L.Tooltip) map.removeLayer(l) });
            hospitalsData.forEach(h => {
                const marker = L.marker([h.lat, h.lng], { icon: getIconForHospital(h) }).addTo(map);
                
                let popupContent = `<b>${h.name}</b><br>`;
                popupContent += `<i>${h.type}</i><br><br>`;
                popupContent += `<b>Status:</b> ${h.status}<br>`;

                if (h.status === 'Disabled') {
                    popupContent += `<hr style="margin: 5px 0;"><b>Transfer Note:</b> ${h.transferNotes || 'N/A'}`;
                } else {
                    const totalBeds = (h.beds.er.t || 0) + (h.beds.icu.t || 0) + (h.beds.sur.t || 0) + (h.beds.gen.t || 0);
                    const availableBeds = (h.beds.er.a || 0) + (h.beds.icu.a || 0) + (h.beds.sur.a || 0) + (h.beds.gen.a || 0);
                    const label = `${availableBeds}/${totalBeds}`;

                    marker.bindTooltip(label, { permanent: true, direction: 'right', offset: [10, 0], className: 'hospital-label' }).openTooltip();
                    
                    popupContent += `<b>Beds Available:</b> ${label}<br>`;
                    popupContent += `<hr style="margin: 5px 0;">`;
                    popupContent += `<b>Staff:</b><br>`;
                    popupContent += `&nbsp;&nbsp;Doctors: ${h.staff?.doctors || 0}<br>`;
                    popupContent += `&nbsp;&nbsp;Specialists: ${h.staff?.specialists || 0}<br>`;
                    popupContent += `&nbsp;&nbsp;Nurses: ${h.staff?.nurses || 0}<br>`;
                    
                    if (h.services && h.services.length > 0) {
                        popupContent += `<hr style="margin: 5px 0;">`;
                        popupContent += `<b>Services:</b> ${h.services.join(', ')}`;
                    }
                }

                marker.bindPopup(popupContent);
            });
        }
        
        window.centerMapOn = (lat, lng) => map.setView([lat, lng], 15);

        document.getElementById('addHospitalBtn').onclick = () => {
            hospitalForm.reset();
            hospitalModal.querySelector('h2').innerText = 'Add Hospital';
            document.getElementById('hospitalId').value = '';
            document.getElementById('location-feedback').textContent = '';
            document.getElementById('transferNotesContainer').classList.add('hidden');
            tempServices = [];
            renderServicesList();
            hospitalModal.style.display = 'flex';
        };

        document.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.onclick = () => btn.closest('.modal').style.display = 'none';
        });

        document.getElementById('setLocationBtn').onclick = () => {
            hospitalModal.style.display = 'none';
            map.getContainer().style.cursor = 'crosshair';
            map.once('click', (e) => {
                document.getElementById('hospitalLat').value = e.latlng.lat;
                document.getElementById('hospitalLng').value = e.latlng.lng;
                document.getElementById('location-feedback').textContent = `Location Set: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
                map.getContainer().style.cursor = '';
                hospitalModal.style.display = 'flex';
            });
        };

        const statusSelect = document.getElementById('hospitalStatus');
        const transferNotesContainer = document.getElementById('transferNotesContainer');
        statusSelect.addEventListener('change', (e) => {
            if (e.target.value === 'Disabled') {
                transferNotesContainer.classList.remove('hidden');
            } else {
                transferNotesContainer.classList.add('hidden');
            }
        });

        hospitalForm.onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('hospitalId').value;
            const hospitalData = {
                name: document.getElementById('hospitalName').value,
                type: document.getElementById('hospitalType').value,
                status: document.getElementById('hospitalStatus').value,
                lat: parseFloat(document.getElementById('hospitalLat').value),
                lng: parseFloat(document.getElementById('hospitalLng').value),
                beds: {
                    er: { t: parseInt(document.getElementById('erBedsTotal').value) || 0, a: parseInt(document.getElementById('erBedsAvailable').value) || 0 },
                    icu: { t: parseInt(document.getElementById('icuBedsTotal').value) || 0, a: parseInt(document.getElementById('icuBedsAvailable').value) || 0 },
                    sur: { t: parseInt(document.getElementById('surBedsTotal').value) || 0, a: parseInt(document.getElementById('surBedsAvailable').value) || 0 },
                    gen: { t: parseInt(document.getElementById('genBedsTotal').value) || 0, a: parseInt(document.getElementById('genBedsAvailable').value) || 0 }
                },
                staff: {
                    doctors: parseInt(document.getElementById('staffDoctors').value) || 0,
                    specialists: parseInt(document.getElementById('staffSpecialists').value) || 0,
                    nurses: parseInt(document.getElementById('staffNurses').value) || 0
                },
                services: [...tempServices],
                transferNotes: document.getElementById('transferNotes').value
            };
            
            if (!hospitalData.lat || !hospitalData.lng) {
                alert("Please set a location on the map."); return;
            }

            if (id) {
                hospitalsData = hospitalsData.map(h => h.id === parseInt(id) ? {id: parseInt(id), ...hospitalData} : h);
            } else {
                hospitalsData.push({ id: Date.now(), ...hospitalData });
            }
            hospitalModal.style.display = 'none';
            renderAll();
        };
        
        window.editHospital = (id) => {
            const hospital = hospitalsData.find(h => h.id === id);
            if (!hospital) return;
            
            hospitalModal.querySelector('h2').innerText = 'Edit Hospital';
            document.getElementById('hospitalId').value = hospital.id;
            document.getElementById('hospitalName').value = hospital.name;
            document.getElementById('hospitalType').value = hospital.type;
            document.getElementById('hospitalStatus').value = hospital.status;
            document.getElementById('hospitalLat').value = hospital.lat;
            document.getElementById('hospitalLng').value = hospital.lng;
            document.getElementById('location-feedback').textContent = `Location Set: ${hospital.lat.toFixed(4)}, ${hospital.lng.toFixed(4)}`;

            if (hospital.status === 'Disabled') {
                transferNotesContainer.classList.remove('hidden');
                document.getElementById('transferNotes').value = hospital.transferNotes;
            } else {
                transferNotesContainer.classList.add('hidden');
                document.getElementById('transferNotes').value = '';
            }

            document.getElementById('erBedsTotal').value = hospital.beds.er.t;
            document.getElementById('erBedsAvailable').value = hospital.beds.er.a;
            document.getElementById('icuBedsTotal').value = hospital.beds.icu.t;
            document.getElementById('icuBedsAvailable').value = hospital.beds.icu.a;
            document.getElementById('surBedsTotal').value = hospital.beds.sur.t;
            document.getElementById('surBedsAvailable').value = hospital.beds.sur.a;
            document.getElementById('genBedsTotal').value = hospital.beds.gen.t;
            document.getElementById('genBedsAvailable').value = hospital.beds.gen.a;

            document.getElementById('staffDoctors').value = hospital.staff?.doctors || '';
            document.getElementById('staffSpecialists').value = hospital.staff?.specialists || '';
            document.getElementById('staffNurses').value = hospital.staff?.nurses || '';

            tempServices = [...hospital.services];
            renderServicesList();
            hospitalModal.style.display = 'flex';
        };

        window.deleteHospital = (id) => {
            showConfirmation("Are you sure you want to delete this hospital?", () => {
                hospitalsData = hospitalsData.filter(h => h.id !== id);
                renderAll();
            });
        };
        
        document.getElementById('addServiceBtn').onclick = () => {
            const newServiceInput = document.getElementById('newService');
            const serviceText = newServiceInput.value.trim();
            if (serviceText && !tempServices.includes(serviceText)) {
                tempServices.push(serviceText);
                newServiceInput.value = '';
                renderServicesList();
            }
        };
        function renderServicesList() {
            const listEl = document.getElementById('servicesList');
            listEl.innerHTML = '';
            tempServices.forEach((service, index) => {
                listEl.innerHTML += `<div class="service-tag text-xs flex items-center gap-2 py-1 px-2 rounded"><span>${service}</span><button type="button" onclick="removeService(${index})" class="text-red-400 hover:text-red-300">&times;</button></div>`;
            });
        }
        window.removeService = (index) => {
            tempServices.splice(index, 1);
            renderServicesList();
        };
        
        function showConfirmation(message, onConfirm) {
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmMsg = document.getElementById('confirmationMessage');
            const confirmBtn = document.getElementById('confirmBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            confirmMsg.textContent = message;
            
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.onclick = () => { onConfirm(); confirmationModal.style.display = 'none'; };
            cancelBtn.onclick = () => { confirmationModal.style.display = 'none'; };
            confirmationModal.style.display = 'flex';
        }
        
        function renderAll() {
            renderHospitalList();
            renderHospitalMarkers();
            lucide.createIcons();
        }

        renderAll();
    </script>
</body>
</html>

