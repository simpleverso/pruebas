<!doctype html>
<html>
  <head>
    <title>Simple Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="./index.css" />
    <!-- Added library to read Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  </head>

  <body>
    <p>Step 1: Initialize WebLLM and Download Model</p>
    <div class="download-container">
      <select id="model-selection"></select>
      <button id="download">Download</button>
    </div>
    <p id="download-status" class="hidden"></p>

    <p>Step 2: Chat</p>
    <div class="chat-container">
      <div id="chat-box" class="chat-box"></div>
      <div id="chat-stats" class="chat-stats hidden"></div>
      <div class="chat-input-container">
        <input type="text" id="user-input" placeholder="Type a message..." />
        <button id="send" disabled>Send</button>
      </div>
    </div>

    <!-- START: New Excel Viewer Section -->
    <p>Step 3: Load and View Excel File</p>
    <div class="excel-container">
      <input
        type="file"
        id="excel-file-input"
        accept=".xls, .xlsx"
        aria-label="Upload Excel file"
      />
      <!-- This div will hold the generated HTML table -->
      <div id="excel-table-output"></div>
    </div>

    <script>
      // Wait for the DOM to be fully loaded before adding event listeners
      document.addEventListener('DOMContentLoaded', (event) => {
        const fileInput = document.getElementById('excel-file-input');
        const outputDiv = document.getElementById('excel-table-output');

        if (fileInput) {
          fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
              return;
            }

            // Clear previous output
            outputDiv.innerHTML = '<p>Loading...</p>';

            const reader = new FileReader();
            reader.onload = (event) => {
              const data = new Uint8Array(event.target.result);

              // Check if XLSX library is loaded
              if (typeof XLSX === 'undefined') {
                console.error('XLSX library not loaded.');
                outputDiv.innerHTML =
                  '<p style="color: red;">Error: Could not load Excel library.</p>';
                return;
              }

              try {
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to a 2D array of values
                const json = XLSX.utils.sheet_to_json(worksheet, {
                  header: 1,
                  defval: '', // Set default value for empty cells
                });

                // Generate and display the HTML table
                outputDiv.innerHTML = generateTable(json);
              } catch (err) {
                console.error('Error processing Excel file:', err);
                outputDiv.innerHTML =
                  '<p style="color: red;">Error: Could not read the file. It might be corrupted or in an unsupported format.</p>';
              }
            };
            reader.onerror = (err) => {
              console.error('FileReader error:', err);
              outputDiv.innerHTML =
                '<p style="color: red;">Error: Could not read the file.</p>';
            };
            reader.readAsArrayBuffer(file);
          });
        }

        /**
         * Generates a column letter (A, B, C...) from a zero-based column index.
         * @param {number} colIndex - The 0-based column index.
         * @returns {string} The corresponding column letter.
         */
        function getColLetter(colIndex) {
          let letter = '';
          let temp;
          while (colIndex >= 0) {
            temp = colIndex % 26;
            letter = String.fromCharCode(temp + 65) + letter;
            colIndex = Math.floor(colIndex / 26) - 1;
          }
          return letter;
        }

        /**
         * Generates an HTML table string from a 2D array of data.
         * @param {Array<Array<any>>} data - The 2D array (from sheet_to_json).
         * @returns {string} The HTML table as a string.
         */
        function generateTable(data) {
          if (!data || data.length === 0) {
            return '<p>No data found in the Excel sheet.</p>';
          }

          let table = '<table>';
          let maxCols = 0;
          data.forEach((row) => {
            if (row.length > maxCols) maxCols = row.length;
          });

          // --- Create Header Row (Column Letters) ---
          table += '<thead><tr>';
          table += '<th></th>'; // Empty corner cell
          for (let c = 0; c < maxCols; c++) {
            table += '<th>' + getColLetter(c) + '</th>';
          }
          table += '</tr></thead>';

          // --- Create Data Rows (with Row Numbers) ---
          table += '<tbody>';
          for (let r = 0; r < data.length; r++) {
            table += '<tr>';
            // Row number cell (using <th> for header semantics)
            table += '<th>' + (r + 1) + '</th>';

            const row = data[r];
            // Data cells
            for (let c = 0; c < maxCols; c++) {
              // Use the value from the row or an empty string if cell doesn't exist
              const cellValue = row[c] !== null && row[c] !== undefined ? row[c] : '';
              // Basic escaping for cell content to prevent HTML injection
              const escapedCellValue = String(cellValue)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
              table += '<td>' + escapedCellValue + '</td>';
            }
            table += '</tr>';
          }
          table += '</tbody>';

          table += '</table>';
          return table;
        }
      });
    </script>
    <!-- END: New Excel Viewer Section -->

    <script src="./index.js" type="module"></script>
  </body>
</html>
