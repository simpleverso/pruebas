<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Snippet Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 12px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
            border-radius: 6px;
            border: 2px solid #2d3748; /* Add a border to make it look inset */
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096; /* gray-500 */
        }
        .sidebar-item.active {
            background-color: #4a5568; /* gray-600 */
        }
        /* Drag and drop styles */
        .sidebar-item.dragging {
            opacity: 0.5;
        }
        .sidebar-item.drag-over {
            border-top: 2px solid #3b82f6; /* blue-500 */
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        /* Responsive sidebar transition */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .search-highlight {
            background-color: #f59e0b; /* amber-500 */
            color: #111827; /* gray-900 */
            border-radius: 2px;
            padding: 0 2px;
        }
    </style>
</head>
<body class="bg-gray-800 text-gray-200 font-sans antialiased overflow-hidden">

    <div id="app" class="relative h-screen flex">
        <!-- Mobile Menu Button -->
        <div class="absolute top-0 left-0 p-4 md:hidden z-30">
            <button id="menu-btn" class="text-white focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </div>

        <!-- Sidebar -->
        <aside id="sidebar" class="bg-gray-900 flex flex-col h-full border-r border-gray-700 fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 z-20 flex-shrink-0">
            <div class="p-4 border-b border-gray-700 flex items-center justify-between min-h-[64px]">
                <h1 class="text-xl font-bold ml-10 md:ml-0">Snippets</h1>
            </div>
            <div class="p-4 space-y-2 border-b border-gray-700">
                <div class="flex space-x-2">
                    <button id="add-text-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        New Text
                    </button>
                    <button id="add-folder-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                       <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        New Folder
                    </button>
                </div>
                 <div class="flex space-x-2 pt-2">
                    <label for="import-file" class="cursor-pointer w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        Import
                    </label>
                    <input type="file" id="import-file" class="hidden" accept=".txt">
                    <button id="export-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Export
                    </button>
                </div>
            </div>
            <div id="sidebar-content" class="flex-grow overflow-y-auto overflow-x-hidden p-2">
                <!-- Items will be injected here -->
            </div>
        </aside>

        <!-- Resizer Handle -->
        <div id="resizer" class="hidden md:flex w-2 cursor-col-resize bg-gray-700 hover:bg-blue-600 focus:bg-blue-600 transition-colors duration-200 z-10 flex-shrink-0 items-center justify-center">
             <div class="w-0.5 h-8 bg-gray-500 rounded-full"></div>
        </div>

        <!-- Main Content -->
        <main id="main-content" class="flex-grow flex flex-col h-screen bg-gray-800">
             <!-- Search Bar -->
            <div class="p-4 border-b border-gray-700 bg-gray-900 flex-shrink-0 flex items-center space-x-2 pt-16 md:pt-4">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <input id="search-input" type="search" placeholder="Search snippets and folders..." class="bg-transparent text-lg w-full focus:outline-none text-gray-200">
            </div>

            <div id="welcome-screen" class="flex-grow flex flex-col items-center justify-center text-gray-500 p-4">
                <svg class="w-24 h-24 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 A0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                <h2 id="welcome-title" class="text-2xl font-semibold text-center">Select an item</h2>
                <p id="welcome-text" class="text-center">Select an item from the sidebar to view or edit its content.</p>
            </div>

            <div id="content-view" class="hidden flex-grow flex-col h-full">
                <div class="p-4 flex items-center justify-between border-b border-gray-700 bg-gray-900 min-h-[64px]">
                    <input id="content-title" class="bg-transparent text-xl font-bold w-full focus:outline-none focus:ring-2 focus:ring-blue-500 rounded px-2 py-1" value="Snippet Name" />
                    <div class="flex space-x-2">
                        <button id="move-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-lg hidden" title="Move Item">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                        </button>
                        <button id="copy-btn" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg" title="Copy Content">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                         <button id="edit-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white p-2 rounded-lg" title="Edit Content">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </button>
                        <button id="save-btn" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded-lg hidden" title="Save Changes">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </button>
                        <button id="delete-btn" class="bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg" title="Delete Item">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="flex-grow p-1">
                     <textarea id="content-area" readonly class="w-full h-full bg-gray-700 text-gray-200 p-4 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono"></textarea>
                </div>
            </div>
        </main>
    </div>

    <!-- Search Modal -->
    <div id="search-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 pointer-events-none opacity-0 p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl flex flex-col max-h-full">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold">Search Results</h3>
                <button id="close-search-modal-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="search-modal-results" class="p-4 overflow-y-auto">
                <!-- Search results will be injected here -->
            </div>
        </div>
    </div>

    <!-- Move Modal -->
    <div id="move-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 pointer-events-none opacity-0">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">Move to...</h3>
            <div id="move-folder-list" class="max-h-64 overflow-y-auto mb-4 bg-gray-900 rounded-lg p-2">
                <!-- Folder list will be injected here -->
            </div>
            <div class="flex justify-end space-x-2">
                <button id="cancel-move-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-40">
        Copied to clipboard!
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let data = [];
            let activeItemId = null;
            let draggedItemId = null;

            // --- DOM ELEMENTS ---
            const sidebar = document.getElementById('sidebar');
            const resizer = document.getElementById('resizer');
            const menuBtn = document.getElementById('menu-btn');
            const mainContent = document.getElementById('main-content');
            const sidebarContent = document.getElementById('sidebar-content');
            const welcomeScreen = document.getElementById('welcome-screen');
            const welcomeTitle = document.getElementById('welcome-title');
            const welcomeText = document.getElementById('welcome-text');
            const contentView = document.getElementById('content-view');
            const contentTitle = document.getElementById('content-title');
            const contentArea = document.getElementById('content-area');
            const copyBtn = document.getElementById('copy-btn');
            const editBtn = document.getElementById('edit-btn');
            const saveBtn = document.getElementById('save-btn');
            const deleteBtn = document.getElementById('delete-btn');
            const moveBtn = document.getElementById('move-btn');
            const addTextBtn = document.getElementById('add-text-btn');
            const addFolderBtn = document.getElementById('add-folder-btn');
            const importFile = document.getElementById('import-file');
            const exportBtn = document.getElementById('export-btn');
            const toast = document.getElementById('toast');
            
            // Modals
            const moveModal = document.getElementById('move-modal');
            const moveFolderList = document.getElementById('move-folder-list');
            const cancelMoveBtn = document.getElementById('cancel-move-btn');
            const searchModal = document.getElementById('search-modal');
            const searchModalResults = document.getElementById('search-modal-results');
            const closeSearchModalBtn = document.getElementById('close-search-modal-btn');
            const searchInput = document.getElementById('search-input');
            
            // --- RESPONSIVE BEHAVIOR ---
            menuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                sidebar.classList.toggle('-translate-x-full');
            });
            
            mainContent.addEventListener('click', () => {
                 if (!sidebar.classList.contains('-translate-x-full') && window.innerWidth < 768) {
                     sidebar.classList.add('-translate-x-full');
                 }
            });

            // --- DATA PERSISTENCE & SIZING ---
            const saveData = () => {
                localStorage.setItem('snippetManagerData', JSON.stringify(data));
            };

            const loadData = () => {
                const savedData = localStorage.getItem('snippetManagerData');
                if (savedData) {
                    data = JSON.parse(savedData);
                }
            };
            
            const saveSidebarWidth = (width) => {
                localStorage.setItem('snippetManagerSidebarWidth', width);
            };

            const applySidebarWidth = (widthStr) => {
                if (window.innerWidth < 768) { // Mobile view
                    sidebar.style.width = ''; // Let CSS handle it via transform
                } else { // Desktop view
                    sidebar.style.width = widthStr;
                }
            };

            const loadSidebarWidth = () => {
                const savedWidth = localStorage.getItem('snippetManagerSidebarWidth');
                const defaultWidth = '288px'; // Tailwind w-72
                applySidebarWidth(savedWidth || defaultWidth);
            };


            // --- RENDER FUNCTIONS ---
            const renderSidebar = () => {
                sidebarContent.innerHTML = '';
                const renderItems = (items, container, level = 0) => {
                    items.forEach(item => {
                        const element = document.createElement('div');
                        element.className = `sidebar-item flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-700 ${item.id === activeItemId ? 'active' : ''}`;
                        element.style.paddingLeft = `${level * 20 + 10}px`;
                        element.dataset.id = item.id;
                        element.draggable = true;
                        
                        const icon = item.type === 'folder' 
                            ? `<svg class="w-5 h-5 mr-2 text-yellow-400 pointer-events-none flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>` 
                            : `<svg class="w-5 h-5 mr-2 text-blue-400 pointer-events-none flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0011.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>`;
                        
                        element.innerHTML = `${icon} <span class="truncate pointer-events-none">${item.name}</span>`;
                        element.addEventListener('click', (e) => {
                            e.stopPropagation(); 
                            activeItemId = item.id;
                            renderContentView(item);
                            renderSidebar();
                             if (window.innerWidth < 768) {
                                sidebar.classList.add('-translate-x-full');
                            }
                        });

                        element.addEventListener('dragstart', handleDragStart);
                        element.addEventListener('dragend', handleDragEnd);
                        element.addEventListener('dragover', handleDragOver);
                        element.addEventListener('dragleave', handleDragLeave);
                        element.addEventListener('drop', handleDrop);

                        container.appendChild(element);

                        if (item.type === 'folder' && item.items) {
                            renderItems(item.items, container, level + 1);
                        }
                    });
                };
                renderItems(data, sidebarContent);
            };

            const renderContentView = (item) => {
                contentArea.readOnly = true;
                saveBtn.classList.add('hidden');
                editBtn.classList.remove('hidden');

                if (!item) {
                    welcomeScreen.classList.remove('hidden');
                    welcomeScreen.classList.add('flex');
                    contentView.classList.add('hidden');
                    contentView.classList.remove('flex');
                    welcomeTitle.textContent = "Select an item";
                    welcomeText.textContent = "Select an item from the sidebar to view or edit its content.";
                    activeItemId = null;
                } else if (item.type === 'folder'){
                    welcomeScreen.classList.remove('hidden');
                    welcomeScreen.classList.add('flex');
                    contentView.classList.add('hidden');
                    contentView.classList.remove('flex');
                    welcomeTitle.textContent = `Folder: ${item.name}`;
                    welcomeText.textContent = "Select a text snippet from the sidebar to view its content.";
                    activeItemId = item.id;
                    moveBtn.classList.add('hidden');
                }
                else {
                    welcomeScreen.classList.add('hidden');
                    welcomeScreen.classList.remove('flex');
                    contentView.classList.remove('hidden');
                    contentView.classList.add('flex');
                    contentTitle.value = item.name;
                    contentArea.value = item.text;
                    moveBtn.classList.remove('hidden');
                }
            };
            
            // --- DATA HELPERS ---
            const findItem = (id, items = data) => {
                for (const item of items) {
                    if (item.id === id) return item;
                    if (item.items) {
                        const found = findItem(id, item.items);
                        if (found) return found;
                    }
                }
                return null;
            };

            const findParentArrayAndIndex = (id, items = data, parentArray = data) => {
                for(let i = 0; i < items.length; i++) {
                    if (items[i].id === id) return { parentArray, index: i };
                    if (items[i].items) {
                        const found = findParentArrayAndIndex(id, items[i].items, items[i].items);
                        if (found) return found;
                    }
                }
                return null;
            };
            
            const findAndRemoveItem = (id, items = data) => {
                 for (let i = items.length - 1; i >= 0; i--) {
                    if (items[i].id === id) {
                        return items.splice(i, 1)[0];
                    }
                    if (items[i].items) {
                        const removedItem = findAndRemoveItem(id, items[i].items);
                        if (removedItem) return removedItem;
                    }
                }
                return null;
            };

            // --- EVENT LISTENERS (Buttons, etc.) ---
            editBtn.addEventListener('click', () => {
                contentArea.readOnly = false;
                editBtn.classList.add('hidden');
                saveBtn.classList.remove('hidden');
                contentArea.focus();
            });

            saveBtn.addEventListener('click', () => {
                const item = findItem(activeItemId);
                if (item) {
                    item.name = contentTitle.value;
                    item.text = contentArea.value;
                    contentArea.readOnly = true;
                    saveBtn.classList.add('hidden');
                    editBtn.classList.remove('hidden');
                    saveData();
                    renderSidebar();
                    showToast('Saved successfully!', 'green');
                }
            });

            copyBtn.addEventListener('click', () => {
                contentArea.select();
                document.execCommand('copy');
                showToast('Copied to clipboard!', 'blue');
            });

            deleteBtn.addEventListener('click', () => {
                if(confirm('Are you sure you want to delete this item?')){
                    findAndRemoveItem(activeItemId);
                    activeItemId = null;
                    saveData();
                    renderContentView(null);
                    renderSidebar();
                    showToast('Item deleted!', 'red');
                }
            });

            addTextBtn.addEventListener('click', () => {
                const name = prompt('Enter the name for the new text snippet:');
                if (name) {
                    const newItem = { id: Date.now(), name, text: '', type: 'text', level: 0 };
                    data.unshift(newItem);
                    activeItemId = newItem.id;
                    saveData();
                    renderSidebar();
                    renderContentView(newItem);
                }
            });

            addFolderBtn.addEventListener('click', () => {
                const name = prompt('Enter the name for the new folder:');
                if (name) {
                    const newItem = { id: Date.now(), name, items: [], type: 'folder', level: 0 };
                    data.unshift(newItem);
                    activeItemId = newItem.id;
                    saveData();
                    renderSidebar();
                    renderContentView(newItem);
                }
            });

            importFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData)) {
                            data = importedData;
                            activeItemId = null;
                            saveData();
                            renderSidebar();
                            renderContentView(null);
                            showToast('Data imported successfully!', 'green');
                        } else {
                           showToast('Invalid file format.', 'red');
                        }
                    } catch (error) {
                         showToast('Error parsing file. Make sure it is a valid JSON file.', 'red');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            });

            exportBtn.addEventListener('click', () => {
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'text/plain' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const date = new Date().toISOString().slice(0, 10);
                link.download = `snippets-backup-${date}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showToast('Data exported!', 'purple');
            });
            
            // --- SEARCH LOGIC ---
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                if (query) {
                    performSearch(query);
                    openSearchModal();
                } else {
                    closeSearchModal();
                }
            });

            const openSearchModal = () => {
                searchModal.classList.remove('hidden', 'pointer-events-none', 'opacity-0');
            };
            const closeSearchModal = () => {
                searchModal.classList.add('hidden', 'pointer-events-none', 'opacity-0');
            };
            closeSearchModalBtn.addEventListener('click', closeSearchModal);

            const performSearch = (query) => {
                const lowerCaseQuery = query.toLowerCase();
                const contentMatches = [];
                const nameMatches = [];
                const folderMatches = [];
                const matchedIds = new Set(); 

                const traverse = (items, path = []) => {
                    items.forEach(item => {
                        const currentPath = [...path, item.name];
                        if (item.type === 'text') {
                            if (item.text && item.text.toLowerCase().includes(lowerCaseQuery)) {
                                contentMatches.push({ ...item, path: currentPath.slice(0, -1) });
                                matchedIds.add(item.id);
                            }
                            if (item.name.toLowerCase().includes(lowerCaseQuery) && !matchedIds.has(item.id)) {
                                nameMatches.push({ ...item, path: currentPath.slice(0, -1) });
                            }
                        } else if (item.type === 'folder') {
                            if (item.name.toLowerCase().includes(lowerCaseQuery)) {
                                folderMatches.push({ ...item, path: currentPath.slice(0, -1) });
                            }
                            if (item.items) {
                                traverse(item.items, currentPath);
                            }
                        }
                    });
                };

                traverse(data);
                renderSearchResults({ contentMatches, nameMatches, folderMatches }, query);
            };

            const renderSearchResults = (results, query) => {
                searchModalResults.innerHTML = '';
                const { contentMatches, nameMatches, folderMatches } = results;

                if (!contentMatches.length && !nameMatches.length && !folderMatches.length) {
                    searchModalResults.innerHTML = `<div class="text-center text-gray-500 py-8">No results found for "<strong>${query}</strong>"</div>`;
                    return;
                }
                
                const highlight = (text, query) => {
                    if (!text || !query) return text;
                    const regex = new RegExp(`(${query.replace(/[\.\+\*?\[\^\]\$\(\)\{\}\=\!\<\>\|\:\-]/g, "\\$&")})`, 'gi');
                    return text.replace(regex, `<span class="search-highlight">$1</span>`);
                };

                const createResultElement = (item, type) => {
                    const resultEl = document.createElement('div');
                    resultEl.className = 'p-3 bg-gray-900 rounded-lg cursor-pointer hover:bg-gray-700 border border-gray-700';
                    resultEl.addEventListener('click', () => handleResultClick(item));

                    const pathHtml = item.path.length > 0 ? `<div class="text-xs text-gray-500 mb-1">${item.path.join(' / ')}</div>` : '';
                    let contentHtml = '';

                    if (type === 'content') {
                        contentHtml = `<p class="text-sm text-gray-400 mt-1 truncate">...${highlight(item.text, query)}...</p>`;
                    }
                    
                    resultEl.innerHTML = `
                        ${pathHtml}
                        <div class="flex items-center">
                            ${item.type === 'folder' 
                                ? `<svg class="w-5 h-5 mr-3 text-yellow-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>` 
                                : `<svg class="w-5 h-5 mr-3 text-blue-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0011.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>`
                            }
                            <span class="font-semibold">${highlight(item.name, query)}</span>
                        </div>
                        ${contentHtml}
                    `;
                    return resultEl;
                };

                const appendSection = (title, items, type) => {
                    if (items.length > 0) {
                        const sectionWrapper = document.createElement('div');
                        const titleEl = document.createElement('h3');
                        titleEl.className = 'text-lg font-bold text-gray-400 my-2 px-2';
                        titleEl.textContent = title;
                        sectionWrapper.appendChild(titleEl);
                        
                        const itemsContainer = document.createElement('div');
                        itemsContainer.className = 'space-y-2';
                        items.forEach(item => itemsContainer.appendChild(createResultElement(item, type)));
                        sectionWrapper.appendChild(itemsContainer);
                        searchModalResults.appendChild(sectionWrapper);
                    }
                };

                appendSection('Snippet Content', contentMatches, 'content');
                appendSection('Snippet Names', nameMatches, 'name');
                appendSection('Folder Names', folderMatches, 'folder');
            };

            const handleResultClick = (item) => {
                closeSearchModal();
                activeItemId = item.id;
                searchInput.value = ''; // Clear search
                renderContentView(item);
                renderSidebar();
            };

            // --- MOVE MODAL LOGIC ---
            moveBtn.addEventListener('click', () => {
                moveFolderList.innerHTML = '';
                const folders = [];
                const findFolders = (items) => {
                    items.forEach(item => {
                        if (item.type === 'folder') {
                            folders.push(item);
                            if (item.items) findFolders(item.items);
                        }
                    });
                };
                findFolders(data);
                
                const rootEl = document.createElement('div');
                rootEl.className = 'p-2 rounded-lg cursor-pointer hover:bg-gray-700';
                rootEl.textContent = '(Root Level)';
                rootEl.addEventListener('click', () => moveItemTo(null));
                moveFolderList.appendChild(rootEl);

                folders.forEach(folder => {
                    if (folder.id === activeItemId) return;
                    const folderEl = document.createElement('div');
                    folderEl.className = 'p-2 rounded-lg cursor-pointer hover:bg-gray-700';
                    folderEl.textContent = folder.name;
                    folderEl.addEventListener('click', () => moveItemTo(folder.id));
                    moveFolderList.appendChild(folderEl);
                });
                moveModal.classList.remove('hidden', 'pointer-events-none', 'opacity-0');
            });

            const closeMoveModal = () => {
                 moveModal.classList.add('hidden','opacity-0', 'pointer-events-none');
            };
            cancelMoveBtn.addEventListener('click', closeMoveModal);

            const moveItemTo = (folderId) => {
                const itemToMove = findAndRemoveItem(activeItemId);
                if (!itemToMove) return;

                if (folderId === null) {
                    data.unshift(itemToMove);
                } else {
                    const targetFolder = findItem(folderId);
                    if (targetFolder && targetFolder.type === 'folder') {
                        targetFolder.items = targetFolder.items || [];
                        targetFolder.items.unshift(itemToMove);
                    }
                }
                activeItemId = null;
                saveData();
                renderSidebar();
                renderContentView(null);
                closeMoveModal();
                showToast('Item moved!', 'indigo');
            };

             // --- DRAG & DROP & RESIZE ---
            sidebarContent.addEventListener('dragover', (e) => e.preventDefault());
            sidebarContent.addEventListener('drop', (e) => {
                e.preventDefault();
                if (e.target === sidebarContent) {
                    const itemToMove = findAndRemoveItem(draggedItemId);
                    if (itemToMove) {
                        data.unshift(itemToMove);
                        saveData();
                        renderSidebar();
                    }
                }
            });

            function handleDragStart(e) { e.stopPropagation(); draggedItemId = parseInt(e.target.dataset.id); e.target.classList.add('dragging'); }
            function handleDragEnd(e) { e.stopPropagation(); e.target.classList.remove('dragging'); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); draggedItemId = null; }
            function handleDragOver(e) { e.preventDefault(); e.stopPropagation(); const targetElement = e.target.closest('.sidebar-item'); if (targetElement && parseInt(targetElement.dataset.id) !== draggedItemId) { document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); targetElement.classList.add('drag-over'); } }
            function handleDragLeave(e) { e.stopPropagation(); e.target.closest('.sidebar-item').classList.remove('drag-over'); }
            function handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                const targetElement = e.target.closest('.sidebar-item');
                if (!targetElement) return;
                const targetId = parseInt(targetElement.dataset.id);
                if (draggedItemId === targetId) return;
                const draggedItem = findAndRemoveItem(draggedItemId);
                if (!draggedItem) return;
                const targetItem = findItem(targetId);
                if(targetItem.type === 'folder') {
                    targetItem.items = targetItem.items || [];
                    targetItem.items.unshift(draggedItem);
                } else {
                    const targetInfo = findParentArrayAndIndex(targetId);
                     if (targetInfo) {
                        targetInfo.parentArray.splice(targetInfo.index, 0, draggedItem);
                    }
                }
                saveData();
                renderSidebar();
            }

            let isResizing = false;
            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });

            const handleMouseMove = (e) => {
                if (!isResizing) return;
                let newWidth = e.clientX;
                if (newWidth < 200) newWidth = 200; // Min width
                if (newWidth > 600) newWidth = 600; // Max width
                sidebar.style.width = `${newWidth}px`;
            };

            const handleMouseUp = () => {
                if (!isResizing) return;
                isResizing = false;
                document.body.style.cursor = 'default';
                document.body.style.userSelect = 'auto';
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                saveSidebarWidth(sidebar.style.width);
            };

            window.addEventListener('resize', loadSidebarWidth);

            // --- UI HELPERS ---
            const showToast = (message, color) => {
                toast.textContent = message;
                toast.className = `fixed bottom-5 right-5 bg-${color}-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-40`;
                toast.classList.remove('opacity-0');
                setTimeout(() => {
                    toast.classList.add('opacity-0');
                }, 3000);
            };

            // --- INITIALIZATION ---
            loadData();
            loadSidebarWidth();
            renderSidebar();
            renderContentView(null);
        });
    </script>
</body>
</html>

